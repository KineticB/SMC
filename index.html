<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì í¬ ê´€ë¦¬ ì»¨ì„¤íŒ… ë¦¬í¬íŠ¸</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* í°íŠ¸ ë° ì»¬ëŸ¬ ë³€ìˆ˜ ì •ì˜ */
        :root {
            --brand-green: #00782b;
            --brand-choco: #604c3e;
            --brand-cream: #f7f3e8;
            --brand-red: #ce1126;
            --brand-blue: #005eb8;
            --white: #ffffff;
            --border-radius: 12px;
        }

        body {
            font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            background-color: var(--brand-cream);
            color: var(--brand-choco);
            margin: 0;
            padding: 20px;
            padding-bottom: 100px; /* ë²„íŠ¼ ê³µê°„ í™•ë³´ */
            line-height: 1.5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        .header-logo {
            text-align: center;
            background-color: var(--brand-green);
            color: var(--white);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-bottom: 5px solid #005a20;
        }

        .header-logo h1 {
            margin: 0;
            font-size: 1.6rem;
            letter-spacing: -1px;
            line-height: 1.2;
        }

        /* ì„¹ì…˜(STEP) ìŠ¤íƒ€ì¼ */
        .step-section {
            background: var(--white);
            border: 2px solid var(--brand-green);
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            overflow: hidden;
            box-shadow: 4px 4px 0px rgba(0, 120, 43, 0.1);
        }

        .step-header {
            background-color: var(--brand-green);
            color: var(--white);
            padding: 12px 20px;
            font-size: 1.1em;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        
        .step-header::before {
            content: 'ğŸ©';
            margin-right: 10px;
            font-size: 1.2em;
        }

        .step-content {
            padding: 20px;
        }

        /* ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ */
        .form-item {
            margin-bottom: 25px;
            border-bottom: 1px dashed #ddd;
            padding-bottom: 20px;
        }

        .form-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        label.item-title {
            display: block;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--brand-green);
            font-size: 1.05em;
        }

        .sub-desc {
            font-size: 0.85em;
            color: #888;
            margin-bottom: 12px;
            background: #f9f9f9;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
        }

        input[type="text"], 
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            background-color: #fdfdfd;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--brand-green);
            background-color: #fff;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2300782b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
        }

        .option-wrapper {
            display: flex;
            gap: 20px;
            align-items: center;
            background: #f0f7f2;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
        }

        .radio-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
            color: var(--brand-choco);
        }
        
        .radio-label input {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            accent-color: var(--brand-green);
        }

        .rating-wrapper {
            display: flex;
            justify-content: space-between;
            background: #f0f7f2;
            padding: 10px 15px;
            border-radius: 30px;
            margin-bottom: 10px;
            border: 1px solid var(--brand-green);
        }

        .rating-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.85em;
            cursor: pointer;
            font-weight: bold;
            color: var(--brand-green);
        }

        .rating-item input {
            margin-bottom: 5px;
            width: 18px; 
            height: 18px;
            accent-color: var(--brand-green);
        }

        .input-group-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .input-box {
            flex: 1;
            min-width: 140px;
        }
        
        .input-box label {
            display: block;
            font-size: 0.85em;
            margin-bottom: 5px;
            color: var(--brand-choco);
            font-weight: bold;
        }

        .input-with-unit {
            position: relative;
        }
        
        .input-with-unit input {
            padding-right: 45px; 
            text-align: right;
            font-weight: bold;
            color: var(--brand-green);
        }
        
        .input-with-unit span {
            position: absolute;
            right: 12px;
            top: 14px;
            color: #999;
            font-size: 0.9em;
            font-weight: bold;
        }

        .file-upload-box {
            background: #fff;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 5px;
        }
        .file-input-group {
            display: flex;
            flex-wrap: nowrap;
            gap: 8px;
            justify-content: space-between;
        }
        .file-input-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 0.8em;
            background: #f8f9fa;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid #eee;
        }
        .file-input-item span {
            font-weight: bold;
            color: var(--brand-choco);
            margin-bottom: 2px;
        }
        .file-input-item input[type="file"] {
            width: 100%;
            font-size: 11px;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            background: #fff;
            padding: 10px;
            border: 2px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .checkbox-wrapper:hover {
            border-color: var(--brand-green);
        }
        .checkbox-wrapper input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            accent-color: var(--brand-green);
        }
        .checkbox-wrapper label {
            font-weight: bold;
            cursor: pointer;
            width: 100%;
        }

        .hidden-area {
            display: none;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-top: 10px;
        }

        /* í•˜ë‹¨ ê³ ì • ë²„íŠ¼ ê·¸ë£¹ - ì•„ì´ì½˜ í”Œë¡œíŒ… ìŠ¤íƒ€ì¼ */
        .btn-group {
            position: fixed;
            bottom: 25px;
            right: 25px;
            display: flex;
            flex-direction: row;
            gap: 15px;
            z-index: 1500;
        }

        .icon-btn {
            width: 58px;
            height: 58px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .icon-btn span { font-size: 10px; margin-top: 2px; font-weight: bold; }
        .icon-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 16px rgba(0,0,0,0.3); }
        .icon-btn:active { transform: scale(0.95); }

        .btn-reset { background-color: var(--brand-red); }
        .btn-save { background-color: var(--brand-choco); }
        .btn-email { background-color: var(--brand-blue); }

        /* ì‚¬ì´ë“œ íŒì—… ìŠ¤íƒ€ì¼ */
        #historyPopup {
            position: fixed;
            top: 0;
            right: -320px;
            width: 300px;
            height: 100%;
            background: white;
            box-shadow: -4px 0 15px rgba(0,0,0,0.1);
            z-index: 2000;
            transition: right 0.3s ease;
            padding: 20px;
            overflow-y: auto;
            border-left: 5px solid var(--brand-green);
        }
        #historyPopup.active { right: 0; }
        .history-header { font-weight: bold; color: var(--brand-green); border-bottom: 2px solid var(--brand-green); margin-bottom: 15px; padding-bottom: 5px; display: flex; justify-content: space-between; }
        .close-popup { cursor: pointer; }
        .history-item { font-size: 13px; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 8px; border-left: 3px solid var(--brand-choco); }
        .history-item b { color: var(--brand-choco); }

        /* ê³¼ê±°ê¸°ë¡ í”Œë¡œíŒ… ë²„íŠ¼ */
        .history-toggle {
            position: fixed;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            background: var(--brand-green);
            color: white;
            padding: 15px 5px;
            border-radius: 10px 0 0 10px;
            cursor: pointer;
            font-size: 12px;
            writing-mode: vertical-rl;
            z-index: 1400;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            font-weight: bold;
        }

        @media (max-width: 600px) {
            .input-group-row { flex-direction: column; gap: 10px; }
            .rating-wrapper { padding: 8px; }
            .rating-item { font-size: 0.75em; }
            .file-input-group { gap: 5px; }
            .file-input-item { padding: 4px; }
            .btn-group { bottom: 15px; right: 15px; gap: 10px; }
            .icon-btn { width: 52px; height: 52px; font-size: 18px; }
        }
    </style>
</head>
<body>

<div id="historyToggle" class="history-toggle" onclick="toggleHistory()">â—€ ê³¼ê±° ê¸°ë¡ ì°¸ê³ </div>
<div id="historyPopup">
    <div class="history-header">
        <span>ì´ì „ ì ê²€ ê¸°ë¡</span>
        <span class="close-popup" onclick="toggleHistory()">âœ–</span>
    </div>
    <div id="historyContent">
        <p style="font-size: 12px; color: #666;">ì í¬ëª…ì„ ì…ë ¥í•˜ë©´ ê¸°ë¡ì´ ë§¤ì¹­ë©ë‹ˆë‹¤.</p>
    </div>
</div>

<div class="container">
    <div class="header-logo">
        <h1>STORE MANAGEMENT<br>CONSULTING REPORT</h1>
        <div style="font-size: 0.9em; opacity: 0.9; margin-top:5px;">ì í¬ ê´€ë¦¬ ì»¨ì„¤íŒ… ë¦¬í¬íŠ¸</div>
    </div>

    <form id="inspectionForm">

        <div class="step-section">
            <div class="step-header">Step 0. ë‹´ë‹¹ ì§€ì  ë° SC</div>
            <div class="step-content">
                <div class="input-group-row">
                    <div class="input-box">
                        <label>ğŸ“… ì ê²€ì¼ì</label>
                        <input type="date" name="inspection_date" id="inspectionDate">
                    </div>
                    <div class="input-box">
                        <label>ğŸ  ì ê²€ ì í¬</label>
                        <input type="text" name="inspection_store_name" id="storeNameInput" placeholder="ì í¬ëª… ì…ë ¥">
                    </div>
                    <div class="input-box">
                        <label>ğŸ·ï¸ ì í¬ ìœ í˜•</label>
                        <select id="storeTypeSelect" name="store_type">
                            <option value="">ìœ í˜• ì„ íƒ</option>
                            <option value="ì œì¡°ì¶œê³ ì ">ì œì¡°ì¶œê³ ì </option>
                            <option value="ì œì¡°ì˜ì—…ì ">ì œì¡°ì˜ì—…ì </option>
                            <option value="ì˜ì—…ì ">ì˜ì—…ì </option>
                        </select>
                    </div>
                </div>
                <div class="input-group-row">
                    <div class="input-box">
                        <label>ğŸ¢ ë‹´ë‹¹ ì§€ì </label>
                        <select id="branchSelect" name="branch_name">
                            <option value="">ì§€ì  ì„ íƒ</option>
                            <option value="ì¤‘ë¶€1ì§€ì ">ì¤‘ë¶€1ì§€ì </option>
                            <option value="ì¤‘ë¶€2ì§€ì ">ì¤‘ë¶€2ì§€ì </option>
                            <option value="ì„œë¶€ì§€ì ">ì„œë¶€ì§€ì </option>
                            <option value="ë™ë¶€ì§€ì ">ë™ë¶€ì§€ì </option>
                        </select>
                    </div>
                    <div class="input-box">
                        <label>ğŸ‘¤ ë‹´ë‹¹ SC</label>
                        <select id="scSelect" name="sc_name">
                            <option value="">ì§€ì ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="step-section">
            <div class="step-header">Step 1. ì ê²€ ì‹œì‘ ì „ (ì‹œì„¤/í™˜ê²½)</div>
            <div class="step-content">
                <p class="sub-desc" style="display:block; background:#fff3cd; color:#856404; border:1px solid #ffeeba;">â€» 1ì (ë‚˜ì¨) ~ 5ì (ì¢‹ìŒ) í‰ê°€ ë° ë¶ˆëŸ‰ ì‹œ ì‚¬ì§„ ë“±ë¡</p>
                <div class="form-item">
                    <label class="item-title" id="title_s1_1">1. ì í¬ ì™¸ê´€ (ë…¸í›„ìƒíƒœ)</label>
                    <div class="rating-wrapper">
                        <label class="rating-item"><input type="radio" name="s1_1_score" value="1">1ì </label>
                        <label class="rating-item"><input type="radio" name="s1_1_score" value="2">2ì </label>
                        <label class="rating-item"><input type="radio" name="s1_1_score" value="3">3ì </label>
                        <label class="rating-item"><input type="radio" name="s1_1_score" value="4">4ì </label>
                        <label class="rating-item"><input type="radio" name="s1_1_score" value="5">5ì </label>
                    </div>
                    <div class="file-upload-box">
                        <div class="file-input-group">
                            <div class="file-input-item"><span>ì¹´ë©”ë¼ ì‹¤í–‰:</span><input type="file" name="file_s1_1_cam" id="file_s1_1_cam" accept="image/*" capture="camera"></div>
                            <div class="file-input-item"><span>íŒŒì¼ ì„ íƒ:</span><input type="file" name="file_s1_1_file" id="file_s1_1_file" accept="image/*"></div>
                        </div>
                    </div>
                </div>
                <div class="form-item">
                    <label class="item-title" id="title_s1_2">2. ì í¬ ë‚´ë¶€ (ì •ë¦¬ìƒíƒœ)</label>
                    <div class="rating-wrapper">
                        <label class="rating-item"><input type="radio" name="s1_2_score" value="1">1ì </label>
                        <label class="rating-item"><input type="radio" name="s1_2_score" value="2">2ì </label>
                        <label class="rating-item"><input type="radio" name="s1_2_score" value="3">3ì </label>
                        <label class="rating-item"><input type="radio" name="s1_2_score" value="4">4ì </label>
                        <label class="rating-item"><input type="radio" name="s1_2_score" value="5">5ì </label>
                    </div>
                    <div class="file-upload-box">
                        <div class="file-input-group">
                            <div class="file-input-item"><span>ì¹´ë©”ë¼ ì‹¤í–‰:</span><input type="file" name="file_s1_2_cam" id="file_s1_2_cam" accept="image/*" capture="camera"></div>
                            <div class="file-input-item"><span>íŒŒì¼ ì„ íƒ:</span><input type="file" name="file_s1_2_file" id="file_s1_2_file" accept="image/*"></div>
                        </div>
                    </div>
                </div>
                <div class="form-item">
                    <label class="item-title" id="title_s1_3">3. ê³ ì§€ë¬¼ ì ê²€ (ë…¸í›„/ë¶ˆí•„ìš” ì œê±°)</label>
                    <div class="rating-wrapper">
                        <label class="rating-item"><input type="radio" name="s1_3_score" value="1">1ì </label>
                        <label class="rating-item"><input type="radio" name="s1_3_score" value="2">2ì </label>
                        <label class="rating-item"><input type="radio" name="s1_3_score" value="3">3ì </label>
                        <label class="rating-item"><input type="radio" name="s1_3_score" value="4">4ì </label>
                        <label class="rating-item"><input type="radio" name="s1_3_score" value="5">5ì </label>
                    </div>
                    <div class="file-upload-box">
                        <div class="file-input-group">
                            <div class="file-input-item"><span>ì¹´ë©”ë¼ ì‹¤í–‰:</span><input type="file" name="file_s1_3_cam" id="file_s1_3_cam" accept="image/*" capture="camera"></div>
                            <div class="file-input-item"><span>íŒŒì¼ ì„ íƒ:</span><input type="file" name="file_s1_3_file" id="file_s1_3_file" accept="image/*"></div>
                        </div>
                    </div>
                </div>
                <div class="form-item">
                    <label class="item-title" id="title_s1_4">4. ê¸°ê¸° ê³ ì¥ ë° êµì²´ í•„ìš” ì‚¬í•­</label>
                    <div class="rating-wrapper">
                        <label class="rating-item"><input type="radio" name="s1_4_score" value="1">1ì </label>
                        <label class="rating-item"><input type="radio" name="s1_4_score" value="2">2ì </label>
                        <label class="rating-item"><input type="radio" name="s1_4_score" value="3">3ì </label>
                        <label class="rating-item"><input type="radio" name="s1_4_score" value="4">4ì </label>
                        <label class="rating-item"><input type="radio" name="s1_4_score" value="5">5ì </label>
                    </div>
                    <div class="file-upload-box">
                        <div class="file-input-group">
                            <div class="file-input-item"><span>ì¹´ë©”ë¼ ì‹¤í–‰:</span><input type="file" name="file_s1_4_cam" id="file_s1_4_cam" accept="image/*" capture="camera"></div>
                            <div class="file-input-item"><span>íŒŒì¼ ì„ íƒ:</span><input type="file" name="file_s1_4_file" id="file_s1_4_file" accept="image/*"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="step-section">
            <div class="step-header">Step 2. ë§¤ì¶œ ê´€ë ¨</div>
            <div class="step-content">
                <div class="form-item"><label class="item-title">1. ëª©í‘œë§¤ì¶œ ë° ì‹¤ì  ì ê²€</label><textarea name="s2_1_comment"></textarea></div>
                <div class="form-item">
                    <label class="item-title">2. ì‹ ì œí’ˆ íŒë§¤ ì‹¤ì  ë¶„ì„</label>
                    <div class="input-group-row">
                        <div class="input-box"><label>ğŸ© ì‹ ì œí’ˆ ë¹„ìœ¨</label><div class="input-with-unit"><input type="number" name="s2_2_ratio" placeholder="0"><span>%</span></div></div>
                        <div class="input-box"><label>ğŸ“ˆ ìƒê¶Œë³„ ì‹ ì œí’ˆ ëŒ€ë¹„ ì¦ê°ìœ¨</label><div class="input-with-unit"><input type="number" name="s2_2_increase" placeholder="0"><span>%</span></div></div>
                    </div>
                    <textarea name="s2_2_comment"></textarea>
                </div>
                <div class="form-item"><label class="item-title">3. ì œí’ˆ í’ˆì ˆì‹œê°„ ë° ë°œì£¼ëŸ‰ ì ê²€</label><textarea name="s2_3_comment"></textarea></div>
                <div class="form-item"><label class="item-title">4. ë„ë„› íê¸° ì‹¤ì  ë° ë°°ë‹¬ ì‹¤ì  ì ê²€</label><textarea name="s2_4_comment"></textarea></div>
                <div class="form-item"><label class="item-title">5. íŒì´‰ ìš´ì˜</label><textarea name="s2_5_comment"></textarea></div>
            </div>
        </div>

        <div class="step-section">
            <div class="step-header">Step 3. ì†ìµ ê´€ë ¨</div>
            <div class="step-content">
                <div class="form-item"><label class="item-title">1. ì†ìµ ë¶€ì§„ì  ê°œì„  ë°©ì•ˆ</label><textarea name="s3_1_comment"></textarea></div>
                <div class="form-item"><label class="item-title">2. ì†ìµ ë¶„ì„</label><textarea name="s3_2_comment"></textarea></div>
            </div>
        </div>

        <div class="step-section">
            <div class="step-header">Step 4. ì¸ì‚¬ ë° ê¸°íƒ€ ì ê²€</div>
            <div class="step-content">
                <div class="form-item">
                    <label class="item-title">1. ì¸ë ¥ ìš´ì˜ ì ì •ì„±</label>
                    <div class="option-wrapper">
                        <label class="radio-label"><input type="radio" name="s4_overtime" value="ì˜ˆ"> ì˜ˆ</label>
                        <label class="radio-label"><input type="radio" name="s4_overtime" value="ì•„ë‹ˆì˜¤"> ì•„ë‹ˆì˜¤</label>
                    </div>
                    <textarea name="s4_1_comment"></textarea>
                </div>
                <div class="form-item">
                    <label class="item-title">2. ì§ì› ë©´ë‹´</label>
                    <div class="checkbox-wrapper"><input type="checkbox" id="interview_check" name="s4_interview_yn"><label for="interview_check">ì§ì› ë©´ë‹´ ì§„í–‰ ì—¬ë¶€</label></div>
                    <div id="interview_area" class="hidden-area">
                        <div class="input-group-row">
                            <div class="input-box"><label>ì´ë¦„</label><input type="text" name="interview_name"></div>
                        </div>
                        <div class="file-upload-box">
                            <div class="file-input-group">
                                <div class="file-input-item"><span>ì¹´ë©”ë¼ ì‹¤í–‰:</span><input type="file" name="file_interview_cam" id="file_interview_cam" accept="image/*" capture="camera"></div>
                                <div class="file-input-item"><span>íŒŒì¼ ì„ íƒ:</span><input type="file" name="file_interview_file" id="file_interview_file" accept="image/*"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-item"><label class="item-title">3. ì—…ë¬´ íŠ¹ì´ì‚¬í•­</label><textarea name="s4_3_special_comment"></textarea></div>
                <div class="form-item">
                    <label class="item-title">4. ì§€ì ì‚¬í•­ ê°œì„  í™•ì¸</label>
                    <div class="checkbox-wrapper"><input type="checkbox" id="improvement_check" name="s4_improvement_yn"><label for="improvement_check">ê°œì„  ì™„ë£Œ ì—¬ë¶€</label></div>
                    <textarea name="s4_4_improvement_comment"></textarea>
                </div>
            </div>
        </div>

        <div id="step5Section" class="step-section">
            <div class="step-header">Step 5. ìƒì‚°í˜• ì í¬ ì „ìš©</div>
            <div class="step-content">
                <div class="form-item"><label class="item-title">1. ìƒì‚° ìˆ˜ìœ¨</label><textarea name="s5_1_comment"></textarea></div>
                <div class="form-item"><label class="item-title">4. ê±´ì˜ì‚¬í•­</label><textarea name="s5_4_suggestion"></textarea></div>
            </div>
        </div>

    </form>

    <div class="btn-group">
        <button type="button" class="icon-btn btn-reset" onclick="resetForm()">ğŸ—‘ï¸<span>ì´ˆê¸°í™”</span></button>
        <button type="button" class="icon-btn btn-save" onclick="saveAsExcel()">ğŸ’¾<span>ì €ì¥</span></button>
        <button type="button" class="icon-btn btn-email" onclick="sendEmail()">âœ‰ï¸<span>ì „ì†¡</span></button>
    </div>
</div>

<script>
    const scList = {
        "ì¤‘ë¶€1ì§€ì ": ["ì •ì§€ì„± SC", "ê°•ë¯¸ì˜¥ SC"], "ì¤‘ë¶€2ì§€ì ": ["ì¥ë¬¸ê·¼ SC", "ì´ì¢…í˜„ SC"],
        "ì„œë¶€ì§€ì ": ["ì†¡ì •í›ˆ SC", "ê°•ì¸êµ¬ SC"], "ë™ë¶€ì§€ì ": ["ì„±ë™ì—° SC", "ì±„ì„±ìš° SC"]
    };

    const webAppUrl = "https://script.google.com/macros/s/AKfycbxbHacOaFcNocI1UzCzdADxDWZN-OFWTMgYHCasJuDIW7Uqvq19khExNKK-JxndytqIww/exec";

    // ì‚¬ì´ë“œ íŒì—… ì œì–´
    function toggleHistory() {
        document.getElementById('historyPopup').classList.toggle('active');
        if(document.getElementById('historyPopup').classList.contains('active')) updateHistory();
    }

    // êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™ ê³¼ê±° ê¸°ë¡ ì¡°íšŒ
    async function updateHistory() {
        const storeName = document.getElementById('storeNameInput').value;
        const historyContent = document.getElementById('historyContent');
        
        if (!storeName) {
            historyContent.innerHTML = "<p style='font-size:12px;'>ì í¬ëª…ì„ ì…ë ¥í•˜ë©´ ê³¼ê±° ê¸°ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤.</p>";
            return;
        }

        historyContent.innerHTML = "<p style='font-size:12px;'>ì¡°íšŒ ì¤‘...</p>";

        try {
            const response = await fetch(`${webAppUrl}?store=${encodeURIComponent(storeName)}`);
            const data = await response.json();

            if (data.length === 0) {
                historyContent.innerHTML = `<div class="history-item"><b>ê¸°ë¡ ì—†ìŒ</b>26.01.05 ì´ì „ ì ê²€ ê¸°ë¡ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            let html = "";
            data.forEach(item => {
                const dateObj = new Date(item.date);
                html += `
                    <div class="history-item">
                        <b>ğŸ“… ì ê²€ì¼: ${dateObj.toLocaleDateString()}</b>
                        - ì§€ì : ${item.branch}<br>
                        - SC: ${item.sc}<br>
                        - ì£¼ìš”ë‚´ìš©: ${item.memo}
                    </div>
                `;
            });
            historyContent.innerHTML = html;
        } catch (e) {
            // ì—°ë™ ì‹¤íŒ¨ ì‹œ ë”ë¯¸ ë°ì´í„°(ì˜ˆì‹œìš©)
            historyContent.innerHTML = `
                <div class="history-item">
                    <b>ğŸ“… 26.01.05 ê¸°ë¡ (ì˜ˆì‹œ)</b>
                    - ì í¬: ${storeName}<br>
                    - ì™¸ê´€: ì–‘í˜¸í•˜ë‚˜ ë³´ì¡°ê°„íŒ ë…¸í›„<br>
                    - ë§¤ì¶œ: ì‹ ì œí’ˆ í”„ë¡œëª¨ì…˜ ê°•í™” ê¶Œê³ <br>
                    - ê¸°íƒ€: ì „ì§ì› ë³´ê±´ì¦ ê°±ì‹  í™•ì¸ ì™„ë£Œ
                </div>
            `;
        }
    }

    document.getElementById("branchSelect").addEventListener("change", function() {
        const scSelect = document.getElementById("scSelect");
        scSelect.innerHTML = '<option value="">SC ì„ íƒ</option>'; 
        if (this.value && scList[this.value]) {
            scList[this.value].forEach(sc => {
                const opt = document.createElement("option"); opt.value = opt.textContent = sc; scSelect.appendChild(opt);
            });
        }
    });

    document.getElementById("interview_check").addEventListener("change", function() {
        document.getElementById("interview_area").style.display = this.checked ? "block" : "none";
    });

    document.getElementById("storeTypeSelect").addEventListener("change", function() {
        document.getElementById("step5Section").style.display = (this.value === "ì˜ì—…ì ") ? "none" : "block";
    });

    function resetForm() {
        if(confirm("ì‘ì„±ëœ ëª¨ë“  ë‚´ìš©ì„ ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            document.getElementById("inspectionForm").reset();
            document.getElementById("interview_area").style.display = "none";
            document.getElementById("step5Section").style.display = "block";
            window.scrollTo(0,0);
        }
    }

    async function getResizedImageData(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width; let height = img.height;
                    const max_size = 600; 
                    if (width > max_size) { height *= max_size / width; width = max_size; }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    async function generateExcelFile() {
        const form = document.getElementById('inspectionForm');
        const formData = new FormData(form);
        const branch = formData.get('branch_name') || "ë¯¸ì„ íƒ";
        const sc = formData.get('sc_name') || "ë¯¸ì„ íƒ";
        const storeName = formData.get('inspection_store_name') || "ë¯¸ì…ë ¥";
        const fileName = `${branch}_${sc}_ì»¨ì„¤íŒ…ë¦¬í¬íŠ¸`;

        const workbook = new ExcelJS.Workbook();
        const sheet = workbook.addWorksheet('ì»¨ì„¤íŒ…ë¦¬í¬íŠ¸');

        sheet.columns = [{ width: 35 }, { width: 45 }, { width: 30 }];
        sheet.addRow(['ì ê²€ ë¦¬í¬íŠ¸ íƒ€ì´í‹€']).font = { bold: true, size: 14 };
        sheet.addRow(['ì í¬ëª…', storeName, 'ì§€ì /SC', `${branch}/${sc}`]);
        
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        return { blob, fileName };
    }

    async function saveAsExcel() {
        try { const { blob, fileName } = await generateExcelFile(); saveAs(blob, `${fileName}.xlsx`); } 
        catch (e) { alert("ì €ì¥ ì‹¤íŒ¨"); }
    }

    async function sendEmail() {
        const branch = document.getElementById("branchSelect").value;
        const sc = document.getElementById("scSelect").value;
        if(!branch || !sc) { alert("ì§€ì ê³¼ SCë¥¼ ì„ íƒí•˜ì„¸ìš”."); return; }
        const { blob, fileName } = await generateExcelFile();
        saveAs(blob, `${fileName}.xlsx`);
        const subject = `[ì œì¶œ] ${fileName}`;
        window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=ì²¨ë¶€íŒŒì¼ í™•ì¸ ë°”ëë‹ˆë‹¤.`;
    }
</script>

</body>
</html>

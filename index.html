<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì í¬ ê´€ë¦¬ ì»¨ì„¤íŒ… ë¦¬í¬íŠ¸</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* í°íŠ¸ ë° ì»¬ëŸ¬ ë³€ìˆ˜ ì •ì˜ */
        :root {
            --brand-green: #00782b;
            --brand-choco: #604c3e;
            --brand-cream: #f7f3e8;
            --brand-red: #ce1126;
            --brand-blue: #005eb8;
            --white: #ffffff;
            --border-radius: 12px;
        }

        body {
            font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            background-color: var(--brand-cream);
            color: var(--brand-choco);
            margin: 0;
            padding: 20px;
            padding-bottom: 100px; /* ë²„íŠ¼ ê³µê°„ í™•ë³´ */
            line-height: 1.5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        .header-logo {
            text-align: center;
            background-color: var(--brand-green);
            color: var(--white);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-bottom: 5px solid #005a20;
        }

        .header-logo h1 {
            margin: 0;
            font-size: 1.6rem;
            letter-spacing: -1px;
            line-height: 1.2;
        }

        /* ì„¹ì…˜(STEP) ìŠ¤íƒ€ì¼ */
        .step-section {
            background: var(--white);
            border: 2px solid var(--brand-green);
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            overflow: hidden;
            box-shadow: 4px 4px 0px rgba(0, 120, 43, 0.1);
        }

        .step-header {
            background-color: var(--brand-green);
            color: var(--white);
            padding: 12px 20px;
            font-size: 1.1em;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        
        .step-header::before {
            content: 'ğŸ©';
            margin-right: 10px;
            font-size: 1.2em;
        }

        .step-content {
            padding: 20px;
        }

        /* ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ */
        .form-item {
            margin-bottom: 25px;
            border-bottom: 1px dashed #ddd;
            padding-bottom: 20px;
        }

        .form-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        label.item-title {
            display: block;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--brand-green);
            font-size: 1.05em;
        }

        .sub-desc {
            font-size: 0.85em;
            color: #888;
            margin-bottom: 12px;
            background: #f9f9f9;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
        }

        /* í…ìŠ¤íŠ¸ ì…ë ¥ì°½ ë° ì…€ë ‰íŠ¸ ë°•ìŠ¤ */
        input[type="text"], 
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            background-color: #fdfdfd;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--brand-green);
            background-color: #fff;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2300782b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
        }

        /* ê³µí†µ ë¼ë””ì˜¤/ì²´í¬ë°•ìŠ¤ ë˜í¼ ìŠ¤íƒ€ì¼ */
        .option-wrapper {
            display: flex;
            gap: 20px;
            align-items: center;
            background: #f0f7f2;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
        }

        .radio-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
            color: var(--brand-choco);
        }
        
        .radio-label input {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            accent-color: var(--brand-green);
        }

        /* ì ìˆ˜ ì„ íƒ (1~5ì ) ë¼ë””ì˜¤ ë²„íŠ¼ */
        .rating-wrapper {
            display: flex;
            justify-content: space-between;
            background: #f0f7f2;
            padding: 10px 15px;
            border-radius: 30px;
            margin-bottom: 10px;
            border: 1px solid var(--brand-green);
        }

        .rating-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.85em;
            cursor: pointer;
            font-weight: bold;
            color: var(--brand-green);
        }

        .rating-item input {
            margin-bottom: 5px;
            width: 18px; 
            height: 18px;
            accent-color: var(--brand-green);
        }

        /* ìˆ«ì ì…ë ¥ ê·¸ë£¹ */
        .input-group-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .input-box {
            flex: 1;
            min-width: 140px;
        }
        
        .input-box label {
            display: block;
            font-size: 0.85em;
            margin-bottom: 5px;
            color: var(--brand-choco);
            font-weight: bold;
        }

        .input-with-unit {
            position: relative;
        }
        
        .input-with-unit input {
            padding-right: 45px; 
            text-align: right;
            font-weight: bold;
            color: var(--brand-green);
        }
        
        .input-with-unit span {
            position: absolute;
            right: 12px;
            top: 14px;
            color: #999;
            font-size: 0.9em;
            font-weight: bold;
        }

        /* íŒŒì¼ ì—…ë¡œë“œ ëª¨ë°”ì¼ ìµœì í™” ìˆ˜ì • */
        .file-upload-box {
            background: #fff;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 5px;
        }
        .file-input-group {
            display: flex;
            flex-wrap: nowrap;
            gap: 8px;
            justify-content: space-between;
        }
        .file-input-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 0.8em;
            background: #f8f9fa;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid #eee;
        }
        .file-input-item span {
            font-weight: bold;
            color: var(--brand-choco);
            margin-bottom: 2px;
        }
        .file-input-item input[type="file"] {
            width: 100%;
            font-size: 11px; /* ëª¨ë°”ì¼ì—ì„œ í…ìŠ¤íŠ¸ê°€ ì•ˆ ê¹¨ì§€ë„ë¡ ì‘ê²Œ ì¡°ì ˆ */
        }

        /* ì²´í¬ë°•ìŠ¤ ë””ìì¸ */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            background: #fff;
            padding: 10px;
            border: 2px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .checkbox-wrapper:hover {
            border-color: var(--brand-green);
        }
        .checkbox-wrapper input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            accent-color: var(--brand-green);
        }
        .checkbox-wrapper label {
            font-weight: bold;
            cursor: pointer;
            width: 100%;
        }

        .hidden-area {
            display: none;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-top: 10px;
        }

        /* í•˜ë‹¨ ê³ ì • ë²„íŠ¼ ê·¸ë£¹ - ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ë¡œ ìˆ˜ì • */
        .btn-group {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: row;
            gap: 10px;
            z-index: 1000;
        }

        .icon-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 18px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        .icon-btn span { font-size: 8px; margin-top: 2px; font-weight: bold; }
        .icon-btn:active { transform: scale(0.9); }

        .btn-reset { background-color: var(--brand-red); }
        .btn-save { background-color: var(--brand-choco); }
        .btn-email { background-color: var(--brand-blue); }
        .btn-history { background-color: var(--brand-green); }
        .btn-cloud { background-color: #f39c12; } /* ì£¼í™©ìƒ‰ í´ë¼ìš°ë“œ ë²„íŠ¼ */

        /* ê³¼ê±° ê¸°ë¡ ëª¨ë‹¬ íŒì—… ì¶”ê°€ */
        #historyModal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-content {
            background: white;
            width: 100%;
            max-width: 400px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .modal-header {
            background: var(--brand-green);
            color: white;
            padding: 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }
        .modal-body { padding: 20px; max-height: 60vh; overflow-y: auto; font-size: 14px; }
        .history-card { background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 5px solid var(--brand-choco); }

        @media (max-width: 600px) {
            .input-group-row { flex-direction: column; gap: 10px; }
            .rating-wrapper { padding: 8px; }
            .rating-item { font-size: 0.75em; }
            .file-input-group { gap: 5px; } /* ê°„ê²© ì¢í˜ */
            .file-input-item { padding: 4px; }
            .btn-group { bottom: 10px; right: 10px; gap: 8px; }
            .icon-btn { width: 45px; height: 45px; font-size: 16px; }
        }
    </style>
</head>
<body>

<div id="historyModal">
    <div class="modal-content">
        <div class="modal-header">
            <span>ê°€ì¥ ìµœê·¼ ì ê²€ ê¸°ë¡</span>
            <span style="cursor:pointer" onclick="closeHistory()">âœ–</span>
        </div>
        <div class="modal-body" id="modalContent">
            ì í¬ëª…ì„ ì…ë ¥í•˜ê³  ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
        </div>
    </div>
</div>

<div class="container">
    <div class="header-logo">
        <h1>STORE MANAGEMENT<br>CONSULTING REPORT</h1>
        <div style="font-size: 0.9em; opacity: 0.9; margin-top:5px;">ì í¬ ê´€ë¦¬ ì»¨ì„¤íŒ… ë¦¬í¬íŠ¸</div>
    </div>

    <form id="inspectionForm">

        <div class="step-section">
            <div class="step-header">Step 0. ë‹´ë‹¹ ì§€ì  ë° SC</div>
            <div class="step-content">
                <div class="input-group-row">
                    <div class="input-box">
                        <label>ğŸ“… ì ê²€ì¼ì</label>
                        <input type="date" name="inspection_date" id="inspectionDate">
                    </div>
                    <div class="input-box">
                        <label>ğŸ  ì ê²€ ì í¬</label>
                        <input type="text" name="inspection_store_name" id="storeNameInput" placeholder="ì í¬ëª… ì…ë ¥">
                    </div>
                    <div class="input-box">
                        <label>ğŸ·ï¸ ì í¬ ìœ í˜•</label>
                        <select id="storeTypeSelect" name="store_type">
                            <option value="">ìœ í˜• ì„ íƒ</option>
                            <option value="ì œì¡°ì¶œê³ ì ">ì œì¡°ì¶œê³ ì </option>
                            <option value="ì œì¡°ì˜ì—…ì ">ì œì¡°ì˜ì—…ì </option>
                            <option value="ì˜ì—…ì ">ì˜ì—…ì </option>
                        </select>
                    </div>
                </div>
                <div class="input-group-row">
                    <div class="input-box">
                        <label>ğŸ¢ ë‹´ë‹¹ ì§€ì </label>
                        <select id="branchSelect" name="branch_name">
                            <option value="">ì§€ì  ì„ íƒ</option>
                            <option value="ì¤‘ë¶€1ì§€ì ">ì¤‘ë¶€1ì§€ì </option>
                            <option value="ì¤‘ë¶€2ì§€ì ">ì¤‘ë¶€2ì§€ì </option>
                            <option value="ì„œë¶€ì§€ì ">ì„œë¶€ì§€ì </option>
                            <option value="ë™ë¶€ì§€ì ">ë™ë¶€ì§€ì </option>
                        </select>
                    </div>
                    <div class="input-box">
                        <label>ğŸ‘¤ ë‹´ë‹¹ SC</label>
                        <select id="scSelect" name="sc_name">
                            <option value="">ì§€ì ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <div class="step-section">
            <div class="step-header">Step 1. ì ê²€ ì‹œì‘ ì „ (ì‹œì„¤/í™˜ê²½)</div>
            <div class="step-content">
                <p class="sub-desc" style="display:block; background:#fff3cd; color:#856404; border:1px solid #ffeeba;">â€» 1ì (ë‚˜ì¨) ~ 5ì (ì¢‹ìŒ) í‰ê°€ ë° ë¶ˆëŸ‰ ì‹œ ì‚¬ì§„ ë“±ë¡</p>
                
                <div class="form-item">
                    <label class="item-title" id="title_s1_1">1. ì í¬ ì™¸ê´€ (ë…¸í›„ìƒíƒœ)</label>
                    <div class="rating-wrapper">
                        <label class="rating-item"><input type="radio" name="s1_1_score" value="1">1ì </label>
                        <label class="rating-item"><input type="radio" name="s1_1_score" value="2">2ì </label>
                        <label class="rating-item"><input type="radio" name="s1_1_score" value="3">3ì </label>
                        <label class="rating-item"><input type="radio" name="s1_1_score" value="4">4ì </label>
                        <label class="rating-item"><input type="radio" name="s1_1_score" value="5">5ì </label>
                    </div>
                    <div class="file-upload-box">
                        <div class="file-input-group">
                            <div class="file-input-item"><span>ì¹´ë©”ë¼ ì‹¤í–‰:</span><input type="file" name="file_s1_1_cam" id="file_s1_1_cam" accept="image/*" capture="camera"></div>
                            <div class="file-input-item"><span>íŒŒì¼ ì„ íƒ:</span><input type="file" name="file_s1_1_file" id="file_s1_1_file" accept="image/*"></div>
                        </div>
                    </div>
                </div>

                <div class="form-item">
                    <label class="item-title" id="title_s1_2">2. ì í¬ ë‚´ë¶€ (ì •ë¦¬ìƒíƒœ)</label>
                    <div class="rating-wrapper">
                        <label class="rating-item"><input type="radio" name="s1_2_score" value="1">1ì </label>
                        <label class="rating-item"><input type="radio" name="s1_2_score" value="2">2ì </label>
                        <label class="rating-item"><input type="radio" name="s1_2_score" value="3">3ì </label>
                        <label class="rating-item"><input type="radio" name="s1_2_score" value="4">4ì </label>
                        <label class="rating-item"><input type="radio" name="s1_2_score" value="5">5ì </label>
                    </div>
                    <div class="file-upload-box">
                        <div class="file-input-group">
                            <div class="file-input-item"><span>ì¹´ë©”ë¼ ì‹¤í–‰:</span><input type="file" name="file_s1_2_cam" id="file_s1_2_cam" accept="image/*" capture="camera"></div>
                            <div class="file-input-item"><span>íŒŒì¼ ì„ íƒ:</span><input type="file" name="file_s1_2_file" id="file_s1_2_file" accept="image/*"></div>
                        </div>
                    </div>
                </div>

                <div class="form-item">
                    <label class="item-title" id="title_s1_3">3. ê³ ì§€ë¬¼ ì ê²€ (ë…¸í›„/ë¶ˆí•„ìš” ì œê±°)</label>
                    <div class="rating-wrapper">
                        <label class="rating-item"><input type="radio" name="s1_3_score" value="1">1ì </label>
                        <label class="rating-item"><input type="radio" name="s1_3_score" value="2">2ì </label>
                        <label class="rating-item"><input type="radio" name="s1_3_score" value="3">3ì </label>
                        <label class="rating-item"><input type="radio" name="s1_3_score" value="4">4ì </label>
                        <label class="rating-item"><input type="radio" name="s1_3_score" value="5">5ì </label>
                    </div>
                    <div class="file-upload-box">
                        <div class="file-input-group">
                            <div class="file-input-item"><span>ì¹´ë©”ë¼ ì‹¤í–‰:</span><input type="file" name="file_s1_3_cam" id="file_s1_3_cam" accept="image/*" capture="camera"></div>
                            <div class="file-input-item"><span>íŒŒì¼ ì„ íƒ:</span><input type="file" name="file_s1_3_file" id="file_s1_3_file" accept="image/*"></div>
                        </div>
                    </div>
                </div>

                <div class="form-item">
                    <label class="item-title" id="title_s1_4">4. ê¸°ê¸° ê³ ì¥ ë° êµì²´ í•„ìš” ì‚¬í•­</label>
                    <div class="rating-wrapper">
                        <label class="rating-item"><input type="radio" name="s1_4_score" value="1">1ì </label>
                        <label class="rating-item"><input type="radio" name="s1_4_score" value="2">2ì </label>
                        <label class="rating-item"><input type="radio" name="s1_4_score" value="3">3ì </label>
                        <label class="rating-item"><input type="radio" name="s1_4_score" value="4">4ì </label>
                        <label class="rating-item"><input type="radio" name="s1_4_score" value="5">5ì </label>
                    </div>
                    <div class="file-upload-box">
                        <div class="file-input-group">
                            <div class="file-input-item"><span>ì¹´ë©”ë¼ ì‹¤í–‰:</span><input type="file" name="file_s1_4_cam" id="file_s1_4_cam" accept="image/*" capture="camera"></div>
                            <div class="file-input-item"><span>íŒŒì¼ ì„ íƒ:</span><input type="file" name="file_s1_4_file" id="file_s1_4_file" accept="image/*"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="step-section">
            <div class="step-header">Step 2. ë§¤ì¶œ ê´€ë ¨</div>
            <div class="step-content">
                
                <div class="form-item">
                    <label class="item-title">1. ëª©í‘œë§¤ì¶œ ë° ì‹¤ì  ì ê²€</label>
                    <div class="sub-desc">ì™¸ë¶€ì±„ë„ ì œì™¸ í›„ ì‹¤ì  ë° ì‹œê°„ëŒ€ ë§¤ì¶œ ì ê²€</div>
                    <textarea name="s2_1_comment" placeholder="íŠ¹ì´ì‚¬í•­ ë° ë¶„ì„ ë‚´ìš© ì…ë ¥"></textarea>
                </div>

                <div class="form-item">
                    <label class="item-title">2. ì‹ ì œí’ˆ íŒë§¤ ì‹¤ì  ë¶„ì„</label>
                    <div class="input-group-row">
                        <div class="input-box">
                            <label>ğŸ© ì‹ ì œí’ˆ ë¹„ìœ¨</label>
                            <div class="input-with-unit">
                                <input type="number" name="s2_2_ratio" placeholder="0"><span>%</span>
                            </div>
                        </div>
                        <div class="input-box">
                            <label>ğŸ“ˆ ìƒê¶Œë³„ ì‹ ì œí’ˆ ëŒ€ë¹„ ì¦ê°ìœ¨</label>
                            <div class="input-with-unit">
                                <input type="number" name="s2_2_increase" placeholder="0"><span>%</span>
                            </div>
                        </div>
                    </div>
                    <textarea name="s2_2_comment" placeholder="ì¦ê° ì›ì¸ ë° ìƒì„¸ ë¶„ì„"></textarea>
                </div>

                <div class="form-item">
                    <label class="item-title">3. ì œí’ˆ í’ˆì ˆì‹œê°„ ë° ë°œì£¼ëŸ‰ ì ê²€</label>
                    <textarea name="s2_3_comment" placeholder="ë°œì£¼ ì ì •ì„± ë° í’ˆì ˆ ê´€ë ¨ ì½”ë©˜íŠ¸"></textarea>
                </div>

                <div class="form-item">
                    <label class="item-title">4. ë„ë„› íê¸° ì‹¤ì  ë° ë°°ë‹¬ ì‹¤ì  ì ê²€</label>
                    <div class="input-group-row">
                        <div class="input-box">
                            <label>ğŸ—‘ï¸ íê¸°ìœ¨</label>
                            <div class="input-with-unit">
                                <input type="number" name="s2_4_waste" step="0.1" placeholder="0"><span>%</span>
                            </div>
                        </div>
                        <div class="input-box">
                            <label>ğŸ›µ í‰ê·  ë°°ë‹¬ í’ˆì ˆì‹œê°„</label>
                            <select name="s2_4_time">
                                <option value="">ì‹œê°„ ì„ íƒ</option>
                                <option value="13:00">13:00</option>
                                <option value="14:00">14:00</option>
                                <option value="15:00">15:00</option>
                                <option value="16:00">16:00</option>
                                <option value="17:00">17:00</option>
                                <option value="18:00">18:00</option>
                                <option value="19:00">19:00</option>
                                <option value="20:00">20:00</option>
                                <option value="21:00">21:00</option>
                            </select>
                        </div>
                    </div>
                    <textarea name="s2_4_comment" placeholder="íê¸° ë° ë°°ë‹¬ ê´€ë ¨ ìƒì„¸ ì½”ë©˜íŠ¸"></textarea>
                </div>

                <div class="form-item">
                    <label class="item-title">5. íŒì´‰ ìš´ì˜ (ì í¬íŒì´‰ / CRM / ì™¸ë¶€ì±„ë„)</label>
                    <textarea name="s2_5_comment" placeholder="íŒì´‰ ì„±ê³¼ ë° í–¥í›„ ìš´ì˜ ê³„íš"></textarea>
                </div>

            </div>
        </div>

        <div class="step-section">
            <div class="step-header">Step 3. ì†ìµ ê´€ë ¨</div>
            <div class="step-content">
                <div class="form-item">
                    <label class="item-title">1. ì†ìµ ë¶€ì§„ì  ìš´ì˜í˜„í™© ë° í™œì„±í™”/ì ˆê° ë°©ì•ˆ</label>
                    <textarea name="s3_1_comment" placeholder="ë§¤ì¶œ í™œì„±í™” ë°©ì•ˆ ë° ë¹„ìš© ì ˆê° ì•„ì´ë””ì–´"></textarea>
                </div>
                <div class="form-item">
                    <label class="item-title">2. ì†ìµ ë¶„ì„ (ì˜ì—…ì´ìµ ì ì ì›ì¸)</label>
                    <textarea name="s3_2_comment" placeholder="ì ì ì‚¬ìœ  ë° êµ¬ì²´ì  ì›ì¸ íŒŒì•…"></textarea>
                </div>
                <div class="form-item">
                    <label class="item-title">3. ìì²´ ì†ìµ (ì™¸ë¶€ì±„ë„ ì œì™¸) ê°œì„  ë°©ì•ˆ</label>
                    <textarea name="s3_3_comment" placeholder="ì í¬ ìì²´ ì†ìµ ê°œì„  ë°©ì•ˆ"></textarea>
                </div>
            </div>
        </div>

        <div class="step-section">
            <div class="step-header">Step 4. ì¸ì‚¬ ë° ê¸°íƒ€ ì ê²€</div>
            <div class="step-content">
                <div class="form-item">
                    <label class="item-title">1. ì¸ë ¥ ìš´ì˜ ì ì •ì„± (52ì‹œê°„, ì¸ê±´ë¹„ ë“±)</label>
                    <div class="option-wrapper">
                        <label class="radio-label"><input type="radio" name="s4_overtime" value="ì˜ˆ"> ì˜ˆ</label>
                        <label class="radio-label"><input type="radio" name="s4_overtime" value="ì•„ë‹ˆì˜¤"> ì•„ë‹ˆì˜¤</label>
                    </div>
                    <textarea name="s4_1_comment"></textarea>
                </div>
                <div class="form-item">
                    <label class="item-title">2. ì§ì› ë©´ë‹´ ë° SHIFT ì ê²€</label>
                    <div class="checkbox-wrapper"><input type="checkbox" id="interview_check" name="s4_interview_yn"><label for="interview_check">ì§ì› ë©´ë‹´ ì§„í–‰ ì—¬ë¶€</label></div>
                    <div id="interview_area" class="hidden-area">
                        <div class="input-group-row">
                            <div class="input-box"><label>ì í¬ëª…</label><input type="text" name="interview_store"></div>
                            <div class="input-box"><label>ì´ë¦„</label><input type="text" name="interview_name"></div>
                            <div class="input-box"><label>ì§ì±…</label><input type="text" name="interview_position"></div>
                        </div>
                        <div class="file-upload-box">
                            <div class="file-input-group">
                                <div class="file-input-item"><span>ì¹´ë©”ë¼ ì‹¤í–‰:</span><input type="file" name="file_interview_cam" id="file_interview_cam" accept="image/*" capture="camera"></div>
                                <div class="file-input-item"><span>íŒŒì¼ ì„ íƒ:</span><input type="file" name="file_interview_file" id="file_interview_file" accept="image/*"></div>
                            </div>
                        </div>
                    </div>
                    <textarea name="s4_2_comment" style="margin-top:15px;"></textarea>
                </div>
                <div class="form-item"><label class="item-title">3. ì§ì˜,ê°€ë§¹ ì—…ë¬´ê°„ íŠ¹ì´ì‚¬í•­ ì‘ì„±</label><textarea name="s4_3_special_comment"></textarea></div>
                <div class="form-item">
                    <label class="item-title">4. Storeí†µí•©ê´€ë¦¬íŒ€ ì ê²€ ì§€ì ì‚¬í•­ ê´€ë ¨</label>
                    <div class="checkbox-wrapper"><input type="checkbox" id="improvement_check" name="s4_improvement_yn"><label for="improvement_check">ì§€ì ì‚¬í•­ ê°œì„  í™•ì¸ ì—¬ë¶€</label></div>
                    <textarea name="s4_4_improvement_comment"></textarea>
                </div>
            </div>
        </div>

        <div id="step5Section" class="step-section">
            <div class="step-header">Step 5. ìƒì‚°í˜• ì í¬ ìˆ˜ìœ¨ ë° ê°œë‹¹ ì¸ê±´ë¹„ í™•ì¸</div>
            <div class="step-content">
                <div class="form-item">
                    <label class="item-title">1. ìƒì‚°í˜• ì í¬ ìˆ˜ìœ¨ ë° ê°œë‹¹ ì¸ê±´ë¹„</label>
                    <div class="input-group-row">
                        <div class="input-box"><label>ğŸ¥£ ë¯¹ìŠ¤ ìˆ˜ìœ¨</label><div class="input-with-unit"><input type="number" name="s5_yield_mix"><span>%</span></div></div>
                        <div class="input-box"><label>ğŸ© 6X ìˆ˜ìœ¨</label><div class="input-with-unit"><input type="number" name="s5_yield_6x"><span>%</span></div></div>
                    </div>
                    <div class="input-group-row">
                        <div class="input-box"><label>ğŸ¬ ì •ë°±ë‹¹ ìˆ˜ìœ¨</label><div class="input-with-unit"><input type="number" name="s5_yield_sugar"><span>%</span></div></div>
                        <div class="input-box"><label>ğŸ’° ê°œë‹¹ ì¸ê±´ë¹„</label><div class="input-with-unit"><input type="number" name="s5_labor_cost"><span>ì›</span></div></div>
                    </div>
                    <textarea name="s5_1_comment"></textarea>
                </div>
                <div class="form-item">
                    <label class="item-title">2. ì œì¡°ì¶œê³  ì˜ì—…ì  ê¸°ê¸° ìƒíƒœ ë° ìˆ˜ë¦¬ í™•ì¸</label>
                    <div class="file-upload-box">
                        <div class="file-input-group">
                            <div class="file-input-item"><span>ì¹´ë©”ë¼ ì‹¤í–‰:</span><input type="file" name="file_s5_machine_cam" id="file_s5_machine_cam" accept="image/*" capture="camera"></div>
                            <div class="file-input-item"><span>íŒŒì¼ ì„ íƒ:</span><input type="file" name="file_s5_machine_file" id="file_s5_machine_file" accept="image/*"></div>
                        </div>
                    </div>
                    <textarea name="s5_2_comment" style="margin-top:10px;"></textarea>
                </div>
                <div class="form-item">
                    <div class="checkbox-wrapper"><input type="checkbox" id="haccp_check" name="haccp_yn"><label for="haccp_check">HACCP ê´€ë ¨ ì„œë¥˜ ë¹„ì¹˜ ë° ì‘ì„± í™•ì¸ ì™„ë£Œ</label></div>
                    <textarea name="s5_3_comment"></textarea>
                </div>
                <div class="form-item">
                    <label class="item-title">4. ì œì¡°ì¶œê³ ,ì˜ì—…ì  ê³ ì¶© ë° ê±´ì˜ì‚¬í•­(ìƒì‚°, ê¸°ê¸°, ì¶œê³ , í”„ë¡œì„¸ì‹± ë“±ë“±)</label>
                    <textarea name="s5_4_suggestion"></textarea>
                </div>
            </div>
        </div>
    </form>

    <div class="btn-group">
        <button type="button" class="icon-btn btn-history" onclick="openHistory()" title="ê³¼ê±° ê¸°ë¡ ì¡°íšŒ">ğŸ“œ<span>ê¸°ë¡</span></button>
        <button type="button" class="icon-btn btn-cloud" onclick="saveToDataCenter()" title="ë°ì´í„° ì„¼í„° ì €ì¥">â˜ï¸<span>DBì €ì¥</span></button>
        <button type="button" class="icon-btn btn-reset" onclick="resetForm()">ğŸ—‘ï¸<span>ì´ˆê¸°í™”</span></button>
        <button type="button" class="icon-btn btn-save" onclick="saveAsExcel()">ğŸ’¾<span>ì €ì¥</span></button>
        <button type="button" class="icon-btn btn-email" onclick="sendEmail()">âœ‰ï¸<span>ì „ì†¡</span></button>
    </div>
</div>

<script>
    const scList = {
        "ì¤‘ë¶€1ì§€ì ": ["ì •ì§€ì„± SC", "ê°•ë¯¸ì˜¥ SC"], "ì¤‘ë¶€2ì§€ì ": ["ì¥ë¬¸ê·¼ SC", "ì´ì¢…í˜„ SC"],
        "ì„œë¶€ì§€ì ": ["ì†¡ì •í›ˆ SC", "ê°•ì¸êµ¬ SC"], "ë™ë¶€ì§€ì ": ["ì„±ë™ì—° SC", "ì±„ì„±ìš° SC"]
    };
    const webAppUrl = "https://script.google.com/macros/s/AKfycbxbHacOaFcNocI1UzCzdADxDWZN-OFWTMgYHCasJuDIW7Uqvq19khExNKK-JxndytqIww/exec";

    // ê³¼ê±° ê¸°ë¡ íŒì—… (ëª¨ë‹¬) ì œì–´
    async function openHistory() {
        const storeName = document.getElementById('storeNameInput').value;
        const modal = document.getElementById('historyModal');
        const content = document.getElementById('modalContent');
        
        if (!storeName) { alert("ì í¬ëª…ì„ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”."); return; }
        modal.style.display = "flex";
        content.innerHTML = "<p style='text-align:center;'>ê¸°ë¡ ì¡°íšŒ ì¤‘...</p>";

        try {
            const response = await fetch(`${webAppUrl}?store=${encodeURIComponent(storeName)}`);
            const data = await response.json();

            if (data && data.length > 0) {
                const latest = data[data.length - 1]; // ê°€ì¥ ìµœê·¼ ë°ì´í„°
                content.innerHTML = `
                    <div class="history-card">
                        <b>ğŸ“… ìµœê·¼ ì ê²€ì¼:</b> ${new Date(latest.date).toLocaleDateString()}<br>
                        <b>ì§€ì /SC:</b> ${latest.branch} / ${latest.sc}<br>
                        <b>ë©”ëª¨:</b><br>${latest.memo || "ê¸°ë¡ ì—†ìŒ"}
                    </div>
                `;
            } else { content.innerHTML = "<p style='text-align:center;'>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>"; }
        } catch (e) { content.innerHTML = "<p style='text-align:center; color:red;'>ì¡°íšŒ ì‹¤íŒ¨</p>"; }
    }

    function closeHistory() { document.getElementById('historyModal').style.display = "none"; }

    // [ê¸°ëŠ¥ ì¶”ê°€] êµ¬ê¸€ ìŠ¤í”„ë ˆë“œ ì‹œíŠ¸ ë°ì´í„° ì„¼í„° ì €ì¥
    async function saveToDataCenter() {
        const form = document.getElementById('inspectionForm');
        const formData = new FormData(form);
        
        const branch = formData.get('branch_name');
        const sc = formData.get('sc_name');
        const store = formData.get('inspection_store_name');
        const date = formData.get('inspection_date');

        if (!branch || !sc || !store || !date) {
            alert("ì§€ì ëª…, ë‹´ë‹¹SC, ì í¬ëª…, ì ê²€ì¼ìë¥¼ ëª¨ë‘ ì…ë ¥í•´ì•¼ ë°ì´í„°ì„¼í„° ì €ì¥ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            return;
        }

        if(!confirm("í˜„ì¬ ì…ë ¥ëœ ë°ì´í„°ë¥¼ ë°ì´í„° ì„¼í„°(êµ¬ê¸€ ì‹œíŠ¸)ì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const data = {
            action: "save",
            store: store,
            date: date,
            branch: branch,
            sc: sc,
            type: formData.get('store_type'),
            memo: formData.get('s2_1_comment') // ì˜ˆì‹œë¡œ ë§¤ì¶œ ì½”ë©˜íŠ¸ ì €ì¥
        };

        try {
            await fetch(webAppUrl, {
                method: "POST",
                mode: "no-cors",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data)
            });
            alert("ë°ì´í„° ì„¼í„° ì €ì¥ì´ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤. (ì‹œíŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”)");
        } catch (e) { alert("ì €ì¥ ì‹œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
    }

    document.getElementById("branchSelect").addEventListener("change", function() {
        const scSelect = document.getElementById("scSelect");
        scSelect.innerHTML = '<option value="">SC ì„ íƒ</option>'; 
        if (this.value && scList[this.value]) {
            scList[this.value].forEach(sc => {
                const opt = document.createElement("option"); opt.value = opt.textContent = sc; scSelect.appendChild(opt);
            });
        }
    });

    document.getElementById("interview_check").addEventListener("change", function() {
        document.getElementById("interview_area").style.display = this.checked ? "block" : "none";
    });

    document.getElementById("storeTypeSelect").addEventListener("change", function() {
        document.getElementById("step5Section").style.display = (this.value === "ì˜ì—…ì ") ? "none" : "block";
    });

    function resetForm() { if(confirm("ëª¨ë“  ë‚´ìš©ì„ ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { document.getElementById("inspectionForm").reset(); document.getElementById("interview_area").style.display = "none"; document.getElementById("step5Section").style.display = "block"; window.scrollTo(0,0); } }

    async function getResizedImageData(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height, max = 600;
                    if (w > max) { h *= max / w; w = max; }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    // [ê¸°ëŠ¥ ë³´ê°•] ë””ìì¸ í¼ì´ ì ìš©ëœ ì—‘ì…€ ìƒì„±
    async function generateExcelFile() {
        const form = document.getElementById('inspectionForm');
        const formData = new FormData(form);
        const branch = formData.get('branch_name') || "ë¯¸ì„ íƒ";
        const sc = formData.get('sc_name') || "ë¯¸ì„ íƒ";
        const storeName = formData.get('inspection_store_name') || "ë¯¸ì…ë ¥";
        const iDate = formData.get('inspection_date') || new Date().toLocaleDateString();
        const fileName = `${branch}_${sc}_ì»¨ì„¤íŒ…ë¦¬í¬íŠ¸`;

        const workbook = new ExcelJS.Workbook();
        const sheet = workbook.addWorksheet('ì»¨ì„¤íŒ…ë¦¬í¬íŠ¸');

        // ë””ìì¸ ìŠ¤íƒ€ì¼ ì •ì˜
        const headerStyle = { fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF00782B' } }, font: { color: { argb: 'FFFFFFFF' }, bold: true, size: 14 }, alignment: { horizontal: 'center', vertical: 'middle' } };
        const labelStyle = { fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F7F2' } }, font: { bold: true, color: { argb: 'FF00782B' } }, border: { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } } };

        sheet.columns = [{ width: 30 }, { width: 50 }, { width: 25 }];

        // íƒ€ì´í‹€
        sheet.mergeCells('A1:C1');
        const title = sheet.getCell('A1');
        title.value = 'CONSULTING REPORT';
        Object.assign(title, headerStyle);
        sheet.getRow(1).height = 35;

        // ê¸°ë³¸ ì •ë³´
        sheet.addRow(['ì ê²€ì¼ì', iDate, '']);
        sheet.addRow(['ì í¬ëª…', storeName, '']);
        sheet.addRow(['ë‹´ë‹¹ SC', `${branch} / ${sc}`, '']);
        [2, 3, 4].forEach(r => sheet.getRow(r).getCell(1).style = labelStyle);

        // ë°ì´í„° ì„¹ì…˜ ìë™ ì¶”ê°€ ë¡œì§ (ìƒëµí•˜ì§€ ì•Šê³  í•µì‹¬ ë””ìì¸ ìœ ì§€)
        sheet.addRow([]);
        const addSection = (title) => {
            const row = sheet.addRow([title]);
            sheet.mergeCells(`A${row.number}:C${row.number}`);
            row.getCell(1).style = headerStyle;
            row.height = 25;
        };

        addSection('Step 1. ì‹œì„¤ ë° í™˜ê²½ ì ê²€');
        const rows = [
            { l: '1. ì í¬ ì™¸ê´€ ì ìˆ˜', v: formData.get('s1_1_score') + 'ì ', c: 'file_s1_1_cam', f: 'file_s1_1_file' },
            { l: 'ë§¤ì¶œ íŠ¹ì´ì‚¬í•­', v: formData.get('s2_1_comment') }
        ];

        for (const dr of rows) {
            const r = sheet.addRow([dr.l, dr.v || '-', '']);
            r.getCell(1).style = labelStyle;
            r.getCell(2).alignment = { wrapText: true, vertical: 'middle' };
            r.height = 80;
            
            const file = (dr.c && document.getElementById(dr.c)?.files[0]) || (dr.f && document.getElementById(dr.f)?.files[0]);
            if (file) {
                const base64 = await getResizedImageData(file);
                const imageId = workbook.addImage({ base64, extension: 'jpeg' });
                sheet.addImage(imageId, { tl: { col: 2.1, row: r.number - 0.95 }, ext: { width: 150, height: 100 } });
            }
        }

        const buffer = await workbook.xlsx.writeBuffer();
        return { blob: new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }), fileName };
    }

    async function saveAsExcel() { try { const { blob, fileName } = await generateExcelFile(); saveAs(blob, `${fileName}.xlsx`); } catch (e) { alert("ì €ì¥ ì‹¤íŒ¨"); } }

    async function sendEmail() {
        const branch = document.getElementById("branchSelect").value;
        const sc = document.getElementById("scSelect").value;
        if(!branch || !sc) { alert("ì§€ì ê³¼ SCë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”."); return; }
        const { blob, fileName } = await generateExcelFile(); saveAs(blob, `${fileName}.xlsx`);
        const subject = `[ì œì¶œ] ${fileName}`;
        window.location.href = `mailto:?subject=${encodeURIComponent(subject)}&body=ë¦¬í¬íŠ¸ ì²¨ë¶€íŒŒì¼ í™•ì¸ ë°”ëë‹ˆë‹¤.`;
    }
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì í¬ ê´€ë¦¬ ì»¨ì„¤íŒ… ë¦¬í¬íŠ¸</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/css/suneditor.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/suneditor@latest/dist/suneditor.min.js"></script>

    <style>
        /* í°íŠ¸ ë° ì»¬ëŸ¬ ë³€ìˆ˜ ì •ì˜ */
        :root {
            --brand-green: #00782b;
            --brand-choco: #604c3e;
            --brand-cream: #f7f3e8;
            --brand-red: #ce1126;
            --brand-blue: #005eb8;
            --white: #ffffff;
            --border-radius: 12px;
        }

        body {
            font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
            background-color: var(--brand-cream);
            color: var(--brand-choco);
            margin: 0;
            padding: 20px;
            padding-bottom: 120px; /* ë²„íŠ¼ ê³µê°„ í™•ë³´ */
            line-height: 1.5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        .header-logo {
            text-align: center;
            background-color: var(--brand-green);
            color: var(--white);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-bottom: 5px solid #005a20;
        }

        .header-logo h1 {
            margin: 0;
            font-size: 1.6rem;
            letter-spacing: -1px;
            line-height: 1.2;
        }

        /* ì„¹ì…˜(STEP) ìŠ¤íƒ€ì¼ */
        .step-section {
            background: var(--white);
            border: 2px solid var(--brand-green);
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            overflow: hidden;
            box-shadow: 4px 4px 0px rgba(0, 120, 43, 0.1);
        }

        .step-header {
            background-color: var(--brand-green);
            color: var(--white);
            padding: 12px 20px;
            font-size: 1.1em;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        
        .step-header::before {
            content: 'ğŸ©';
            margin-right: 10px;
            font-size: 1.2em;
        }

        .step-content {
            padding: 20px;
        }

        /* ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ */
        .form-item {
            margin-bottom: 25px;
            border-bottom: 1px dashed #ddd;
            padding-bottom: 20px;
        }

        .form-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        label.item-title {
            display: block;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--brand-green);
            font-size: 1.05em;
        }

        .sub-desc {
            font-size: 0.85em;
            color: #888;
            margin-bottom: 12px;
            background: #f9f9f9;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
        }

        /* í…ìŠ¤íŠ¸ ì…ë ¥ì°½ ë° ì…€ë ‰íŠ¸ ë°•ìŠ¤ */
        input[type="text"], 
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
            background-color: #fdfdfd;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--brand-green);
            background-color: #fff;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2300782b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
        }

        /* ì…ì²´ì  ë””ìì¸ í…Œì´ë¸” ìŠ¤íƒ€ì¼ (2-1, 2-4, 4-1 ì ìš©) */
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 15px;
            font-size: 0.85em;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 6px 15px rgba(0,0,0,0.1); /* ì…ì²´ì  ê·¸ë¦¼ì */
            border: 1px solid var(--brand-green);
        }
        .data-table th { 
            background: linear-gradient(180deg, var(--brand-green) 0%, #005a20 100%); /* ì…ì²´ì  ê·¸ë¼ë°ì´ì…˜ */
            color: var(--white); 
            padding: 12px 5px;
            font-weight: 600;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
            border: none;
        }
        .data-table td {
            border-bottom: 1px solid #edf2f0;
            border-right: 1px solid #edf2f0;
            padding: 10px 5px;
            text-align: center;
            background-color: #fff;
        }
        .data-table td:last-child { border-right: none; }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table input { 
            border: 1px solid #e2e8e4 !important; 
            width: 90%; 
            text-align: right; 
            background: #fdfdfd; 
            padding: 5px !important;
            border-radius: 4px;
        }
        .bg-gray { background-color: #f9fbf9 !important; font-weight: bold; color: var(--brand-green); }

        /* ê³µí†µ ë¼ë””ì˜¤/ì²´í¬ë°•ìŠ¤ ë˜í¼ ìŠ¤íƒ€ì¼ */
        .option-wrapper {
            display: flex;
            gap: 20px;
            align-items: center;
            background: #f0f7f2;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
        }

        .radio-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
            color: var(--brand-choco);
        }
        
        .radio-label input {
            margin-right: 8px;
            width: 18px;
            height: 18px;
            accent-color: var(--brand-green);
        }

        /* ì ìˆ˜ ì„ íƒ (1~5ì ) ë¼ë””ì˜¤ ë²„íŠ¼ */
        .rating-wrapper {
            display: flex;
            justify-content: space-between;
            background: #f0f7f2;
            padding: 10px 15px;
            border-radius: 30px;
            margin-bottom: 10px;
            border: 1px solid var(--brand-green);
        }

        .rating-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.85em;
            cursor: pointer;
            font-weight: bold;
            color: var(--brand-green);
        }

        .rating-item input {
            margin-bottom: 5px;
            width: 18px; 
            height: 18px;
            accent-color: var(--brand-green);
        }

        /* ìˆ«ì ì…ë ¥ ê·¸ë£¹ */
        .input-group-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .input-box {
            flex: 1;
            min-width: 140px;
        }
        
        .input-box label {
            display: block;
            font-size: 0.85em;
            margin-bottom: 5px;
            color: var(--brand-choco);
            font-weight: bold;
        }

        .input-with-unit {
            position: relative;
        }
        
        .input-with-unit input {
            padding-right: 45px; 
            text-align: right;
            font-weight: bold;
            color: var(--brand-green);
        }
        
        .input-with-unit span {
            position: absolute;
            right: 12px;
            top: 14px;
            color: #999;
            font-size: 0.9em;
            font-weight: bold;
        }

        /* íŒŒì¼ ì—…ë¡œë“œ ëª¨ë°”ì¼ ìµœì í™” ìˆ˜ì • */
        .file-upload-box {
            background: #fff;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 5px;
        }
        .file-input-group {
            display: flex;
            flex-wrap: nowrap;
            gap: 8px;
            justify-content: space-between;
        }
        .file-input-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
            font-size: 0.8em;
            background: #f8f9fa;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid #eee;
        }
        .file-input-item span {
            font-weight: bold;
            color: var(--brand-choco);
            margin-bottom: 2px;
        }
        .file-input-item input[type="file"] {
            width: 100%;
            font-size: 11px; 
        }

        /* ì²´í¬ë°•ìŠ¤ ë””ìì¸ */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            background: #fff;
            padding: 10px;
            border: 2px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .checkbox-wrapper:hover {
            border-color: var(--brand-green);
        }
        .checkbox-wrapper input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            accent-color: var(--brand-green);
        }
        .checkbox-wrapper label {
            font-weight: bold;
            cursor: pointer;
            width: 100%;
        }

        /* ìˆ¨ê¹€ ì˜ì—­ (ì¡°ê±´ë¶€ í‘œì‹œ) */
        .hidden-area {
            display: none;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-top: 10px;
        }

        /* í•˜ë‹¨ ê³ ì • ë²„íŠ¼ ê·¸ë£¹ - ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ë¡œ ìˆ˜ì • */
        .btn-group {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: row;
            gap: 10px;
            z-index: 1000;
        }

        .icon-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            color: white;
            font-size: 18px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        .icon-btn span { font-size: 8px; margin-top: 2px; font-weight: bold; }
        .icon-btn:active { transform: scale(0.9); }

        .btn-reset { background-color: var(--brand-red); }
        .btn-save { background-color: var(--brand-choco); }
        .btn-email { background-color: var(--brand-blue); }
        .btn-history { background-color: var(--brand-green); }
        .btn-cloud { background-color: #f39c12; } 

        #historyModal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-content {
            background: white;
            width: 100%;
            max-width: 400px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .modal-header {
            background: var(--brand-green);
            color: white;
            padding: 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }
        .modal-body { padding: 20px; max-height: 60vh; overflow-y: auto; font-size: 14px; }
        .history-card { background: #f8f9fa; padding: 12px; border-radius: 8px; border-left: 5px solid var(--brand-choco); }

        @media (max-width: 600px) {
            .input-group-row { flex-direction: column; gap: 10px; }
            .rating-wrapper { padding: 8px; }
            .rating-item { font-size: 0.75em; }
            .file-input-group { gap: 5px; } 
            .file-input-item { padding: 4px; }
            .btn-group { bottom: 10px; right: 10px; gap: 8px; }
            .icon-btn { width: 45px; height: 45px; font-size: 16px; }
        }
    </style>
</head>
<body>

<div id="historyModal">
    <div class="modal-content">
        <div class="modal-header">
            <span>ê°€ì¥ ìµœê·¼ ì ê²€ ê¸°ë¡</span>
            <span style="cursor:pointer" onclick="closeHistory()">âœ–</span>
        </div>
        <div class="modal-body" id="modalContent">
            ì í¬ëª…ì„ ì…ë ¥í•˜ê³  ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
        </div>
    </div>
</div>

<div class="container">
    <div class="header-logo">
        <h1>STORE MANAGEMENT<br>CONSULTING REPORT</h1>
        <div style="font-size: 0.9em; opacity: 0.9; margin-top:5px;">ì í¬ ê´€ë¦¬ ì»¨ì„¤íŒ… ë¦¬í¬íŠ¸</div>
    </div>

    <form id="inspectionForm">

        <div class="step-section">
            <div class="step-header">Step 0. ë‹´ë‹¹ ì§€ì  ë° SC</div>
            <div class="step-content">
                <div class="input-group-row">
                    <div class="input-box">
                        <label>ğŸ“… ì ê²€ì¼ì</label>
                        <input type="date" name="inspection_date" id="inspectionDate">
                    </div>
                    <div class="input-box">
                        <label>ğŸ  ì ê²€ ì í¬</label>
                        <input type="text" name="inspection_store_name" id="storeNameInput" placeholder="ì í¬ëª… ì…ë ¥">
                    </div>
                    <div class="input-box">
                        <label>ğŸ·ï¸ ì í¬ ìœ í˜•</label>
                        <select id="storeTypeSelect" name="store_type">
                            <option value="">ìœ í˜• ì„ íƒ</option>
                            <option value="ì œì¡°ì¶œê³ ì ">ì œì¡°ì¶œê³ ì </option>
                            <option value="ì œì¡°ì˜ì—…ì ">ì œì¡°ì˜ì—…ì </option>
                            <option value="ì˜ì—…ì ">ì˜ì—…ì </option>
                            <option value="ì™¸ë¶€í™œë™(ë¯¸ì ê²€)">ì™¸ë¶€í™œë™(ë¯¸ì ê²€)</option>
                        </select>
                    </div>
                </div>
                <div class="input-group-row">
                    <div class="input-box">
                        <label>ğŸ¢ ë‹´ë‹¹ ì§€ì </label>
                        <select id="branchSelect" name="branch_name">
                            <option value="">ì§€ì  ì„ íƒ</option>
                            <option value="ì¤‘ë¶€1ì§€ì ">ì¤‘ë¶€1ì§€ì </option>
                            <option value="ì¤‘ë¶€2ì§€ì ">ì¤‘ë¶€2ì§€ì </option>
                            <option value="ì„œë¶€ì§€ì ">ì„œë¶€ì§€ì </option>
                            <option value="ë™ë¶€ì§€ì ">ë™ë¶€ì§€ì </option>
                        </select>
                    </div>
                    <div class="input-box">
                        <label>ğŸ‘¤ ë‹´ë‹¹ SC</label>
                        <select id="scSelect" name="sc_name">
                            <option value="">ì§€ì ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                </div>

                <div id="outsideArea" class="hidden-area" style="border: 2px solid var(--brand-red); margin-top:20px;">
                    <label class="item-title" style="color:var(--brand-red)">Out Step. ì í¬ ì»¨ì„¤íŒ… ë¯¸ì§„í–‰ìœ¼ë¡œ ì¸í•œ SC ì—…ë¬´ê°„ íŠ¹ì´ì‚¬í•­ ì‘ì„±(ìƒì„¸)</label>
                    <div id="outsideEditor"></div>
                    <input type="hidden" name="outside_comment_html" id="outsideCommentHtml">
                </div>
            </div>
        </div>

        <div id="mainSteps">
            <div class="step-section">
                <div class="step-header">Step 1. ì ê²€ ì‹œì‘ ì „ (ì‹œì„¤/í™˜ê²½)</div>
                <div class="step-content">
                    <p class="sub-desc" style="display:block; background:#fff3cd; color:#856404; border:1px solid #ffeeba;">â€» 1ì (ë‚˜ì¨) ~ 5ì (ì¢‹ìŒ) í‰ê°€ ë° ë¶ˆëŸ‰ ì‹œ ì‚¬ì§„ ë“±ë¡</p>
                    
                    <div class="form-item">
                        <label class="item-title" id="title_s1_1">1. ì í¬ ì™¸ê´€ (ë…¸í›„ìƒíƒœ)</label>
                        <div class="rating-wrapper">
                            <label class="rating-item"><input type="radio" name="s1_1_score" value="1">1ì </label>
                            <label class="rating-item"><input type="radio" name="s1_1_score" value="2">2ì </label>
                            <label class="rating-item"><input type="radio" name="s1_1_score" value="3">3ì </label>
                            <label class="rating-item"><input type="radio" name="s1_1_score" value="4">4ì </label>
                            <label class="rating-item"><input type="radio" name="s1_1_score" value="5">5ì </label>
                        </div>
                        <div class="file-upload-box">
                            <div class="file-input-group">
                                <div class="file-input-item"><span>ì¹´ë©”ë¼ ì‹¤í–‰:</span><input type="file" name="file_s1_1_cam" id="file_s1_1_cam" accept="image/*" capture="camera"></div>
                                <div class="file-input-item"><span>íŒŒì¼ ì„ íƒ:</span><input type="file" name="file_s1_1_file" id="file_s1_1_file" accept="image/*"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-item">
                        <label class="item-title" id="title_s1_2">2. ì í¬ ë‚´ë¶€ (ì •ë¦¬ìƒíƒœ)</label>
                        <div class="rating-wrapper">
                            <label class="rating-item"><input type="radio" name="s1_2_score" value="1">1ì </label>
                            <label class="rating-item"><input type="radio" name="s1_2_score" value="2">2ì </label>
                            <label class="rating-item"><input type="radio" name="s1_2_score" value="3">3ì </label>
                            <label class="rating-item"><input type="radio" name="s1_2_score" value="4">4ì </label>
                            <label class="rating-item"><input type="radio" name="s1_2_score" value="5">5ì </label>
                        </div>
                        <div class="file-upload-box">
                            <div class="file-input-group">
                                <div class="file-input-item"><span>ì¹´ë©”ë¼ ì‹¤í–‰:</span><input type="file" name="file_s1_2_cam" id="file_s1_2_cam" accept="image/*" capture="camera"></div>
                                <div class="file-input-item"><span>íŒŒì¼ ì„ íƒ:</span><input type="file" name="file_s1_2_file" id="file_s1_2_file" accept="image/*"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-item">
                        <label class="item-title" id="title_s1_3">3. ê³ ì§€ë¬¼ ì ê²€ (ë…¸í›„/ì œê±°/ì¶”ê°€ì œì‘í•„ìš”)</label>
                        <div class="rating-wrapper">
                            <label class="rating-item"><input type="radio" name="s1_3_score" value="1">1ì </label>
                            <label class="rating-item"><input type="radio" name="s1_3_score" value="2">2ì </label>
                            <label class="rating-item"><input type="radio" name="s1_3_score" value="3">3ì </label>
                            <label class="rating-item"><input type="radio" name="s1_3_score" value="4">4ì </label>
                            <label class="rating-item"><input type="radio" name="s1_3_score" value="5">5ì </label>
                        </div>
                        <textarea name="s1_3_add_comment" placeholder="ê³ ì§€ë¬¼ ì¶”ê°€ì œì‘ ê´€ë ¨ ë‚´ìš© ì…ë ¥"></textarea>
                        <div class="file-upload-box">
                            <div class="file-input-group">
                                <div class="file-input-item"><span>ì¹´ë©”ë¼ ì‹¤í–‰:</span><input type="file" name="file_s1_3_cam" id="file_s1_3_cam" accept="image/*" capture="camera"></div>
                                <div class="file-input-item"><span>íŒŒì¼ ì„ íƒ:</span><input type="file" name="file_s1_3_file" id="file_s1_3_file" accept="image/*"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-item">
                        <label class="item-title" id="title_s1_4">4. ê¸°ê¸° ê³ ì¥ ë° êµì²´ í•„ìš” ì‚¬í•­</label>
                        <div class="rating-wrapper">
                            <label class="rating-item"><input type="radio" name="s1_4_score" value="1">1ì </label>
                            <label class="rating-item"><input type="radio" name="s1_4_score" value="2">2ì </label>
                            <label class="rating-item"><input type="radio" name="s1_4_score" value="3">3ì </label>
                            <label class="rating-item"><input type="radio" name="s1_4_score" value="4">4ì </label>
                            <label class="rating-item"><input type="radio" name="s1_4_score" value="5">5ì </label>
                        </div>
                        <div class="file-upload-box">
                            <div class="file-input-group">
                                <div class="file-input-item"><span>ì¹´ë©”ë¼ ì‹¤í–‰:</span><input type="file" name="file_s1_4_cam" id="file_s1_4_cam" accept="image/*" capture="camera"></div>
                                <div class="file-input-item"><span>íŒŒì¼ ì„ íƒ:</span><input type="file" name="file_s1_4_file" id="file_s1_4_file" accept="image/*"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-item">
                        <label class="item-title" id="title_s1_6">5. ì í¬ìƒê¶Œ ë³€í™”í™•ì¸</label>
                        <textarea name="s1_6_comment" placeholder="200M ë‚´ì™¸ ìƒê¶ŒíŒŒì•…"></textarea>
                    </div>
                </div>
            </div>

            <div class="step-section">
                <div class="step-header">Step 2. ë§¤ì¶œ ê´€ë ¨</div>
                <div class="step-content">
                    
                    <div class="form-item">
                        <label class="item-title">1. ë§¤ì¶œ ì‹¤ì  ë¶„ì„ (ë‹¨ìœ„: ì²œì›)</label>
                        <table class="data-table" id="salesTable">
                            <thead>
                                <tr><th>êµ¬ë¶„(ì²œì›)</th><th>ë§¤ì¶œ</th><th>ì™¸ë¶€ì±„ë„</th><th>ë°°ë‹¬</th><th>ë‹¨ì²´</th><th>ìˆœìˆ˜ë˜ì </th></tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>ì „ë…„</td>
                                    <td><input type="number" name="s2_1_last_total" oninput="calcS2_1()"></td>
                                    <td><input type="number" name="s2_1_last_ext" oninput="calcS2_1()"></td>
                                    <td><input type="number" name="s2_1_last_del"></td>
                                    <td><input type="number" name="s2_1_last_grp"></td>
                                    <td class="bg-gray" id="s2_1_last_pure">0</td>
                                </tr>
                                <tr>
                                    <td>ê¸ˆë…„</td>
                                    <td><input type="number" name="s2_1_curr_total" oninput="calcS2_1()"></td>
                                    <td><input type="number" name="s2_1_curr_ext" oninput="calcS2_1()"></td>
                                    <td><input type="number" name="s2_1_curr_del"></td>
                                    <td><input type="number" name="s2_1_curr_grp"></td>
                                    <td class="bg-gray" id="s2_1_curr_pure">0</td>
                                </tr>
                                <tr class="bg-gray">
                                    <td>ì¦ê°(%)</td>
                                    <td id="s2_1_diff_total">0(0%)</td>
                                    <td colspan="4" style="text-align:right; padding-right:20px;">ìˆœìˆ˜ë˜ì  ì¦ê°: <span id="s2_1_diff_pure">0(0%)</span></td>
                                </tr>
                            </tbody>
                        </table>
                        <textarea name="s2_1_comment" placeholder="íŠ¹ì´ì‚¬í•­ ë° ë¶„ì„ ë‚´ìš© ì…ë ¥"></textarea>
                    </div>

                    <div class="form-item">
                        <label class="item-title">2. ë¸”ëŸ­ë³„ ë§¤ì¶œ ë¶„ì„</label>
                        <select id="blockSelector" style="margin-bottom:10px;">
                            <option value="">ë¶„ì„ ë¸”ëŸ­ ì„ íƒ</option>
                            <option value="ë”ì¦Œ">ë”ì¦Œ</option>
                            <option value="ì‹±ê¸€">ì‹±ê¸€</option>
                            <option value="ì„¸íŠ¸">ì„¸íŠ¸</option>
                            <option value="ì—ìŠ¤í”„ë ˆì†Œ">ì—ìŠ¤í”„ë ˆì†Œ</option>
                            <option value="í”„ë¡œì¦Œ">í”„ë¡œì¦Œ</option>
                            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                        </select>
                        <div id="blockTableContainer"></div>
                        <textarea name="s2_2_comment" placeholder="ì¦ê° ì›ì¸ ë° ìƒì„¸ ë¶„ì„"></textarea>
                    </div>

                    <div class="form-item">
                        <label class="item-title">3. ë„ë„› í’ˆì ˆ, íê¸° ë° ë°°ë‹¬ì‹¤ì </label>
                        <div class="sub-desc">í‰ê·  í’ˆì ˆ ì‹œê°„ ë° ì‹¤ì  ì ê²€</div>
                        <table class="data-table">
                            <tr>
                                <th>OG í’ˆì ˆ</th>
                                <td>
                                    <select name="s2_3_og_time">
                                        <option value="ë¯¸ë°œìƒ">ë¯¸ë°œìƒ</option>
                                        <script>for(let i=12; i<=21; i++) document.write(`<option value="${i}:00">${i}:00</option>`);</script>
                                    </select>
                                </td>
                                <th>ì–´ì˜í‹°ë“œ í’ˆì ˆ</th>
                                <td>
                                    <select name="s2_3_as_time">
                                        <option value="ë¯¸ë°œìƒ">ë¯¸ë°œìƒ</option>
                                        <script>for(let i=12; i<=21; i++) document.write(`<option value="${i}:00">${i}:00</option>`);</script>
                                    </select>
                                </td>
                            </tr>
                            <tr>
                                <th>ë°°ë‹¬ í’ˆì ˆì‹œê°„</th>
                                <td>
                                    <select name="s2_3_del_time">
                                        <option value="ë¯¸ë°œìƒ">ë¯¸ë°œìƒ</option>
                                        <script>for(let i=12; i<=21; i++) document.write(`<option value="${i}:00">${i}:00</option>`);</script>
                                    </select>
                                </td>
                                <th>íê¸°ìœ¨(%)</th>
                                <td><input type="number" name="s2_3_waste_rate" step="0.1"></td>
                            </tr>
                        </table>
                        <textarea name="s2_3_comment" placeholder="ë°œì£¼ ì ì •ì„± ë° í’ˆì ˆ ê´€ë ¨ ì½”ë©˜íŠ¸"></textarea>
                    </div>

                    <div class="form-item">
                        <label class="item-title">4. íŒì´‰ ìš´ì˜ (ì í¬íŒì´‰ / CRM / ì™¸ë¶€ì±„ë„)</label>
                        <table class="data-table">
                            <thead><tr><th>íŒì´‰ëª…</th><th>ì¶”ê°€ë§¤ì¶œ</th><th>ë§¤ì¶œêµ¬ì„±ë¹„(%)</th></tr></thead>
                            <tbody>
                                <tr><td><input type="text" name="s2_4_promo1"></td><td><input type="number" name="s2_4_val1"></td><td><input type="number" name="s2_4_per1"></td></tr>
                                <tr><td><input type="text" name="s2_4_promo2"></td><td><input type="number" name="s2_4_val2"></td><td><input type="number" name="s2_4_per2"></td></tr>
                            </tbody>
                        </table>
                        <textarea name="s2_4_comment" placeholder="íŒì´‰ ì„±ê³¼ ë° í–¥í›„ ìš´ì˜ ê³„íš"></textarea>
                    </div>

                    <div class="form-item">
                        <label class="item-title">5. ë‹¨ì²´ì£¼ë¬¸(CR í™œë™)</label>
                        <textarea name="s2_5_comment" placeholder="ë‹¨ì²´ê³ ê° ë¦¬ìŠ¤íŠ¸ - DMë°œì†¡ ë° ë¶„ê¸°ë³„ ê´€ë¦¬"></textarea>
                    </div>
                </div>
            </div>

            <div class="step-section">
                <div class="step-header">Step 3. ì†ìµ ê´€ë ¨</div>
                <div class="step-content">
                    <div class="form-item">
                        <label class="item-title">1. ê³„ì •ê³¼ëª©ë³„ ë¶„ì„ (ìµœê·¼ í™•ì¸ëœ ì í¬ ì†ìµê³„ì‚°ì„œ ê¸°ì¤€)</label>
                        <div id="accountTableContainer"></div>
                        <button type="button" onclick="addAccountTable()" style="padding: 10px; background: var(--brand-blue); color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 15px;">+ ê³„ì •ê³¼ëª© ì„ íƒí•˜ì—¬ ì¶”ê°€</button>
                        <textarea name="s3_1_comment" placeholder="ì†ìµ ë¶€ì§„ì  ìš´ì˜í˜„í™© ë° í™œì„±í™”/ì ˆê° ë°©ì•ˆ"></textarea>
                    </div>
                    <div class="form-item"><label class="item-title">2. ì†ìµ ë¶„ì„ (ì˜ì—…ì´ìµ ì ì ì›ì¸)</label><textarea name="s3_2_comment"></textarea></div>
                    <div class="form-item"><label class="item-title">3. ìì²´ ì†ìµ (ì™¸ë¶€ì±„ë„ ì œì™¸) ê°œì„  ë°©ì•ˆ</label><textarea name="s3_3_comment"></textarea></div>
                </div>
            </div>

            <div class="step-section">
                <div class="step-header">Step 4. ì¸ì‚¬ ë° ê¸°íƒ€ ì ê²€</div>
                <div class="step-content">
                    <div class="form-item">
                        <label class="item-title">1. ì¸ë ¥ ìš´ì˜ ì ì •ì„± (52ì‹œê°„, ì¸ê±´ë¹„ ë“±)</label>
                        <table class="data-table">
                            <thead>
                                <tr><th>êµ¬ë¶„</th><th>ë©”ì´íŠ¸ ì¸ê±´ë¹„(ì²œì›)</th><th>ì‚¬ìš©ì‹œê°„</th><th>ë‚´ìš©(ì¦ê°ìœ¨)</th></tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>ì „ë…„</td>
                                    <td><input type="number" name="s4_1_last_cost" oninput="calcS4_1()"></td>
                                    <td><input type="number" name="s4_1_last_time"></td>
                                    <td rowspan="2" id="s4_1_res" class="bg-gray">0%</td>
                                </tr>
                                <tr>
                                    <td>ê¸ˆë…„</td>
                                    <td><input type="number" name="s4_1_curr_cost" oninput="calcS4_1()"></td>
                                    <td><input type="number" name="s4_1_curr_time"></td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="option-wrapper">
                            <label class="radio-label"><input type="radio" name="s4_overtime" value="ì˜ˆ"> ì˜ˆ</label>
                            <label class="radio-label"><input type="radio" name="s4_overtime" value="ì•„ë‹ˆì˜¤"> ì•„ë‹ˆì˜¤</label>
                        </div>
                        <textarea name="s4_1_comment" placeholder="ì¸ê±´ë¹„ ë¶„ì„ ë° ìš´ì˜ ì ì •ì„± ì½”ë©˜íŠ¸"></textarea>
                    </div>
                    <div class="form-item">
                        <label class="item-title">2. ì§ì› ë©´ë‹´ ë° SHIFT ì ê²€</label>
                        <div class="checkbox-wrapper"><input type="checkbox" id="interview_check" name="s4_interview_yn"><label for="interview_check">ì§ì› ë©´ë‹´ ì§„í–‰ ì—¬ë¶€</label></div>
                        <div id="interview_area" class="hidden-area">
                            <div class="input-group-row">
                                <div class="input-box"><label>ì í¬ëª…</label><input type="text" name="interview_store"></div>
                                <div class="input-box"><label>ì´ë¦„</label><input type="text" name="interview_name"></div>
                                <div class="input-box"><label>ì§ì±…</label><input type="text" name="interview_position"></div>
                            </div>
                            <div class="file-upload-box">
                                <div class="file-input-group">
                                    <div class="file-input-item"><span>ì¹´ë©”ë¼ ì‹¤í–‰:</span><input type="file" name="file_interview_cam" id="file_interview_cam" accept="image/*" capture="camera"></div>
                                    <div class="file-input-item"><span>íŒŒì¼ ì„ íƒ:</span><input type="file" name="file_interview_file" id="file_interview_file" accept="image/*"></div>
                                </div>
                            </div>
                        </div>
                        <textarea name="s4_2_comment" style="margin-top:15px;"></textarea>
                    </div>
                    <div class="form-item"><label class="item-title">3. ì§ì˜,ê°€ë§¹ ì—…ë¬´ê°„ íŠ¹ì´ì‚¬í•­ ì‘ì„±</label><textarea name="s4_3_special_comment"></textarea></div>
                    <div class="form-item">
                        <label class="item-title">4. Storeí†µí•©ê´€ë¦¬íŒ€ ì ê²€ ì§€ì ì‚¬í•­ ê´€ë ¨</label>
                        <div class="checkbox-wrapper"><input type="checkbox" id="improvement_check" name="s4_improvement_yn"><label for="improvement_check">ì§€ì ì‚¬í•­ ê°œì„  í™•ì¸ ì—¬ë¶€</label></div>
                        <textarea name="s4_4_improvement_comment"></textarea>
                    </div>
                </div>
            </div>

            <div id="step5Section" class="step-section">
                <div class="step-header">Step 5. ìƒì‚°í˜• ì í¬ ìˆ˜ìœ¨ ë° ê°œë‹¹ ì¸ê±´ë¹„ í™•ì¸</div>
                <div class="step-content">
                    <div class="form-item">
                        <label class="item-title">1. ìƒì‚°í˜• ì í¬ ìˆ˜ìœ¨ ë° ê°œë‹¹ ì¸ê±´ë¹„</label>
                        <div class="input-group-row">
                            <div class="input-box"><label>ğŸ¥£ ë¯¹ìŠ¤ ìˆ˜ìœ¨</label><div class="input-with-unit"><input type="number" name="s5_yield_mix"><span>%</span></div></div>
                            <div class="input-box"><label>ğŸ© 6X ìˆ˜ìœ¨</label><div class="input-with-unit"><input type="number" name="s5_yield_6x"><span>%</span></div></div>
                        </div>
                        <div class="input-group-row">
                            <div class="input-box"><label>ğŸ¬ ì •ë°±ë‹¹ ìˆ˜ìœ¨</label><div class="input-with-unit"><input type="number" name="s5_yield_sugar"><span>%</span></div></div>
                            <div class="input-box"><label>ğŸ’° ê°œë‹¹ ì¸ê±´ë¹„</label><div class="input-with-unit"><input type="number" name="s5_labor_cost"><span>ì›</span></div></div>
                        </div>
                        <textarea name="s5_1_comment"></textarea>
                    </div>
                    <div class="form-item">
                        <label class="item-title">2. ì œì¡°ì¶œê³  ì˜ì—…ì  ê¸°ê¸° ìƒíƒœ ë° ìˆ˜ë¦¬ í™•ì¸</label>
                        <div class="file-upload-box">
                            <div class="file-input-group">
                                <div class="file-input-item"><span>ì¹´ë©”ë¼ ì‹¤í–‰:</span><input type="file" name="file_s5_machine_cam" id="file_s5_machine_cam" accept="image/*" capture="camera"></div>
                                <div class="file-input-item"><span>íŒŒì¼ ì„ íƒ:</span><input type="file" name="file_s5_machine_file" id="file_s5_machine_file" accept="image/*"></div>
                            </div>
                        </div>
                        <textarea name="s5_2_comment" style="margin-top:10px;"></textarea>
                    </div>
                    <div class="form-item">
                       <label class="item-title">3. ì œì¡°ì  í•´ì„­(HACCP) ì„œë¥˜ í™•ì¸</label>
                        <div class="checkbox-wrapper"><input type="checkbox" id="haccp_check" name="haccp_yn"><label for="haccp_check">HACCP ê´€ë ¨ ì„œë¥˜ ë¹„ì¹˜ ë° ì‘ì„± í™•ì¸ ì™„ë£Œ</label></div>
                        <textarea name="s5_3_comment"></textarea>
                    </div>
                    <div class="form-item">
                        <label class="item-title">4. ì œì¡°ì¶œê³ ,ì˜ì—…ì  ê³ ì¶© ë° ê±´ì˜ì‚¬í•­</label>
                        <textarea name="s5_4_suggestion"></textarea>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <div class="btn-group">
        <button type="button" class="icon-btn btn-history" onclick="openHistory()" title="ê³¼ê±° ê¸°ë¡ ì¡°íšŒ">ğŸ“œ<span>ê¸°ë¡</span></button>
        <button type="button" class="icon-btn btn-cloud" onclick="saveToDataCenter()" title="ë°ì´í„° ì„¼í„° ì €ì¥">â˜ï¸<span>DBì €ì¥</span></button>
        <button type="button" class="icon-btn btn-reset" onclick="resetForm()">ğŸ—‘ï¸<span>ì´ˆê¸°í™”</span></button>
        <button type="button" class="icon-btn btn-save" onclick="saveAsExcel()">ğŸ’¾<span>ì €ì¥</span></button>
        <button type="button" class="icon-btn btn-email" onclick="sendEmail()">âœ‰ï¸<span>ì „ì†¡</span></button>
    </div>
</div>

<script>
    const scList = { "ì¤‘ë¶€1ì§€ì ": ["ì •ì§€ì„± SC", "ê°•ë¯¸ì˜¥ SC"], "ì¤‘ë¶€2ì§€ì ": ["ì¥ë¬¸ê·¼ SC", "ì´ì¢…í˜„ SC"], "ì„œë¶€ì§€ì ": ["ì†¡ì •í›ˆ SC", "ê°•ì¸êµ¬ SC"], "ë™ë¶€ì§€ì ": ["ì„±ë™ì—° SC", "ì±„ì„±ìš° SC"] };
    let editorInstance;

    window.onload = function() {
        editorInstance = SUNEDITOR.create('outsideEditor', {
            buttonList: [['undo', 'redo'], ['font', 'fontSize', 'formatBlock'], ['bold', 'underline', 'italic', 'strike'], ['fontColor', 'hiliteColor'], ['removeFormat'], ['align', 'list', 'lineHeight'], ['table', 'link', 'image']],
            width: '100%', height: '250px', placeholder: 'ìƒì„¸ íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”...'
        });
    };

    document.getElementById("storeTypeSelect").addEventListener("change", function() {
        const val = this.value;
        const mainSteps = document.getElementById("mainSteps");
        const outsideArea = document.getElementById("outsideArea");
        const step5 = document.getElementById("step5Section");

        if(val === "ì™¸ë¶€í™œë™(ë¯¸ì ê²€)") {
            mainSteps.style.display = "none";
            outsideArea.style.display = "block";
        } else {
            mainSteps.style.display = "block";
            outsideArea.style.display = "none";
            step5.style.display = (val === "ì˜ì—…ì ") ? "none" : "block";
        }
    });

    function calcS2_1() {
        const lastTotal = Number(document.getElementsByName('s2_1_last_total')[0].value) || 0;
        const lastExt = Number(document.getElementsByName('s2_1_last_ext')[0].value) || 0;
        const currTotal = Number(document.getElementsByName('s2_1_curr_total')[0].value) || 0;
        const currExt = Number(document.getElementsByName('s2_1_curr_ext')[0].value) || 0;

        const lastPure = lastTotal - lastExt;
        const currPure = currTotal - currExt;

        document.getElementById('s2_1_last_pure').innerText = lastPure.toLocaleString();
        document.getElementById('s2_1_curr_pure').innerText = currPure.toLocaleString();

        const diffTotal = currTotal - lastTotal;
        const perTotal = lastTotal ? ((diffTotal/lastTotal)*100).toFixed(1) : 0;
        document.getElementById('s2_1_diff_total').innerText = `${diffTotal.toLocaleString()}(${perTotal}%)`;

        const diffPure = currPure - lastPure;
        const perPure = lastPure ? ((diffPure/lastPure)*100).toFixed(1) : 0;
        document.getElementById('s2_1_diff_pure').innerText = `${diffPure.toLocaleString()}(${perPure}%)`;
    }

    document.getElementById("blockSelector").addEventListener("change", function() {
        const val = this.value;
        if(!val) return;
        const container = document.getElementById("blockTableContainer");
        const tableId = `block_table_${val}`;
        if(document.getElementById(tableId)) { alert("ì´ë¯¸ ì¶”ê°€ëœ ë¸”ëŸ­ì…ë‹ˆë‹¤."); return; }

        const tableHtml = `
            <div id="${tableId}" style="margin-bottom:20px; border:1px solid #ddd; padding:15px; border-radius:10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center;">
                    <strong style="color:var(--brand-green)">â–  ë¸”ëŸ­: ${val}</strong>
                    <span style="cursor:pointer; color:red; font-size:12px;" onclick="this.parentElement.parentElement.remove()">âŒ ì‚­ì œ</span>
                </div>
                <table class="data-table">
                    <tr><th>êµ¬ë¶„</th><th>ì „ì²´ë§¤ì¶œ</th><th>ë¸”ëŸ­ë§¤ì¶œ</th><th>êµ¬ì„±ë¹„(%)</th><th>ì¦ê°ìœ¨(%)</th></tr>
                    <tr>
                        <td>ì „ë…„</td>
                        <td><input type="number" id="block_lt_${val}" oninput="calcBlock('${val}')"></td>
                        <td><input type="number" id="block_ls_${val}" oninput="calcBlock('${val}')"></td>
                        <td id="block_lr_${val}" class="bg-gray">0%</td>
                        <td rowspan="2" id="block_di_${val}" class="bg-gray">0%</td>
                    </tr>
                    <tr>
                        <td>ê¸ˆë…„</td>
                        <td><input type="number" id="block_ct_${val}" oninput="calcBlock('${val}')"></td>
                        <td><input type="number" id="block_cs_${val}" oninput="calcBlock('${val}')"></td>
                        <td id="block_cr_${val}" class="bg-gray">0%</td>
                    </tr>
                </table>
            </div>`;
        container.insertAdjacentHTML('beforeend', tableHtml);
        this.value = "";
    });

    function calcBlock(val) {
        const lt = Number(document.getElementById(`block_lt_${val}`).value) || 0;
        const ls = Number(document.getElementById(`block_ls_${val}`).value) || 0;
        const ct = Number(document.getElementById(`block_ct_${val}`).value) || 0;
        const cs = Number(document.getElementById(`block_cs_${val}`).value) || 0;

        document.getElementById(`block_lr_${val}`).innerText = lt ? ((ls/lt)*100).toFixed(1) + '%' : '0%';
        document.getElementById(`block_cr_${val}`).innerText = ct ? ((cs/ct)*100).toFixed(1) + '%' : '0%';
        document.getElementById(`block_di_${val}`).innerText = ls ? (((cs-ls)/ls)*100).toFixed(1) + '%' : '0%';
    }

    let accCount = 0;
    function addAccountTable() {
        accCount++;
        const container = document.getElementById("accountTableContainer");
        const tableHtml = `
            <div style="margin-bottom:20px; border:1px solid var(--brand-blue); padding:15px; border-radius:10px; background:#fff; box-shadow:0 4px 10px rgba(0,0,0,0.05);">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center;">
                    <strong style="color:var(--brand-blue)">â–  ê³„ì •ê³¼ëª© ë¶„ì„ (#${accCount})</strong>
                    <span style="cursor:pointer; font-size:12px; border:1px solid #ff0000; padding:2px 6px; border-radius:4px; color:#ff0000;" onclick="this.parentElement.parentElement.remove()">í•­ëª©ì‚­ì œ</span>
                </div>
                <table class="data-table">
                    <tr><th>ê³„ì •ê³¼ëª© ì„ íƒ</th><th>ì „ë…„ì‹¤ì </th><th>ê¸ˆë…„ì‹¤ì </th><th>ì¦ê°ìœ¨(%)</th></tr>
                    <tr>
                        <td>
                            <select name="s3_acc_type_${accCount}" style="padding:4px; font-size:12px; border:1px solid #ddd; width:100%">
                                <option>ì›ê°€</option><option>ì¸ê±´ë¹„(ë©”ì´íŠ¸)</option><option>ì¸ê±´ë¹„(í‡´ì§ê¸ˆ)</option>
                                <option>ë³µë¦¬í›„ìƒë¹„</option><option>ìˆ˜ì„ ìœ ì§€ë¹„</option><option>ì§ë°°ì†¡ë¬¼ë¥˜ë¹„</option>
                                <option>ìˆ˜ë„ê´‘ì—´ë¹„</option><option>ì†Œëª¨í’ˆë¹„</option>
                            </select>
                        </td>
                        <td><input type="number" id="s3_last_${accCount}" oninput="calcS3(${accCount})" style="width:90%"></td>
                        <td><input type="number" id="s3_curr_${accCount}" oninput="calcS3(${accCount})" style="width:90%"></td>
                        <td id="s3_res_${accCount}" class="bg-gray">0%</td>
                    </tr>
                </table>
                <textarea name="s3_comment_${accCount}" style="margin-top:5px; height:60px;" placeholder="ë¶„ì„ ì½”ë©˜íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            </div>`;
        container.insertAdjacentHTML('beforeend', tableHtml);
    }

    function calcS3(idx) {
        const last = Number(document.getElementById(`s3_last_${idx}`).value) || 0;
        const curr = Number(document.getElementById(`s3_curr_${idx}`).value) || 0;
        const res = last ? (((curr - last) / last) * 100).toFixed(1) : 0;
        document.getElementById(`s3_res_${idx}`).innerText = res + '%';
    }

    function calcS4_1() {
        const last = Number(document.getElementsByName('s4_1_last_cost')[0].value) || 0;
        const curr = Number(document.getElementsByName('s4_1_curr_cost')[0].value) || 0;
        const res = last ? (((curr - last) / last) * 100).toFixed(1) : 0;
        document.getElementById('s4_1_res').innerText = res + '%';
    }

    document.getElementById("branchSelect").addEventListener("change", function() {
        const scSelect = document.getElementById("scSelect");
        scSelect.innerHTML = '<option value="">SC ì„ íƒ</option>'; 
        if (this.value && scList[this.value]) {
            scList[this.value].forEach(sc => { const option = document.createElement("option"); option.value = sc; option.textContent = sc; scSelect.appendChild(option); });
        }
    });

    document.getElementById("interview_check").addEventListener("change", function() { document.getElementById("interview_area").style.display = this.checked ? "block" : "none"; });
    function resetForm() { if(confirm("ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { location.reload(); } }

    async function saveAsExcel() {
        const workbook = new ExcelJS.Workbook();
        const sheet = workbook.addWorksheet('Report');
        const form = document.getElementById('inspectionForm');
        const formData = new FormData(form);
        const branch = formData.get('branch_name') || "ë¯¸ì„ íƒ";
        const sc = formData.get('sc_name') || "ë¯¸ì„ íƒ";
        const storeName = formData.get('inspection_store_name') || "ë¯¸ì…ë ¥";
        const iDate = formData.get('inspection_date') || new Date().toISOString().split('T')[0];
        
        // íŒŒì¼ëª… ì„¤ì •
        const fileName = `${branch}_${sc}_ì»¨ì„¤íŒ…ë¦¬í¬íŠ¸(${iDate})`;

        // ìŠ¤íƒ€ì¼ ì •ì˜
        const headerStyle = { fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF00782B' } }, font: { color: { argb: 'FFFFFFFF' }, bold: true }, alignment: { horizontal: 'center' }, border: { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} } };
        const labelStyle = { fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF7F3E8' } }, font: { bold: true }, border: { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} } };
        const dataStyle = { border: { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} }, alignment: { wrapText: true, vertical: 'middle' } };

        sheet.columns = [{ width: 25 }, { width: 40 }, { width: 25 }, { width: 40 }];

        // íƒ€ì´í‹€
        sheet.mergeCells('A1:D1');
        const titleCell = sheet.getCell('A1');
        titleCell.value = 'STORE MANAGEMENT CONSULTING REPORT';
        titleCell.style = headerStyle;
        titleCell.font = { size: 14, color: { argb: 'FFFFFFFF' }, bold: true };

        // ê¸°ë³¸ì •ë³´
        const infoRows = [
            ['ì ê²€ì í¬', storeName, 'ì ê²€ì¼ì', iDate],
            ['ë‹´ë‹¹ì§€ì ', branch, 'ë‹´ë‹¹SC', sc],
            ['ì í¬ìœ í˜•', formData.get('store_type'), '', '']
        ];
        infoRows.forEach(r => {
            const row = sheet.addRow(r);
            row.getCell(1).style = labelStyle; row.getCell(2).style = dataStyle;
            row.getCell(3).style = labelStyle; row.getCell(4).style = dataStyle;
        });

        if(formData.get('store_type') === "ì™¸ë¶€í™œë™(ë¯¸ì ê²€)") {
            sheet.addRow([]);
            const outTitle = sheet.addRow(['â–  ì™¸ë¶€í™œë™ íŠ¹ì´ì‚¬í•­']);
            outTitle.getCell(1).style = headerStyle;
            const content = sheet.addRow([editorInstance.getText()]);
            sheet.mergeCells(`A${content.number}:D${content.number + 5}`);
            content.getCell(1).style = dataStyle;
        } else {
            // Step 1
            sheet.addRow([]);
            const s1Header = sheet.addRow(['â–  Step 1. ì‹œì„¤ ë° í™˜ê²½ ì ê²€']);
            sheet.mergeCells(`A${s1Header.number}:D${s1Header.number}`);
            s1Header.getCell(1).style = headerStyle;
            sheet.addRow(['í•­ëª©', 'ì ìˆ˜/ë‚´ìš©', '', '']);
            sheet.addRow(['ì í¬ ì™¸ê´€', formData.get('s1_1_score') + 'ì ']);
            sheet.addRow(['ì í¬ ë‚´ë¶€', formData.get('s1_2_score') + 'ì ']);
            sheet.addRow(['ê³ ì§€ë¬¼ ì ê²€', formData.get('s1_3_score') + 'ì  / ' + formData.get('s1_3_add_comment')]);

            // Step 2-1 ë§¤ì¶œ
            sheet.addRow([]);
            const s2Header = sheet.addRow(['â–  Step 2. ë§¤ì¶œ ë° ì‹¤ì  ë¶„ì„']);
            sheet.mergeCells(`A${s2Header.number}:D${s2Header.number}`);
            s2Header.getCell(1).style = headerStyle;
            sheet.addRow(['êµ¬ë¶„', 'ì´ë§¤ì¶œ', 'ì™¸ë¶€ì±„ë„', 'ìˆœìˆ˜ë‚´ì ']);
            sheet.addRow(['ì „ë…„', formData.get('s2_1_last_total'), formData.get('s2_1_last_ext'), document.getElementById('s2_1_last_pure').innerText]);
            sheet.addRow(['ê¸ˆë…„', formData.get('s2_1_curr_total'), formData.get('s2_1_curr_ext'), document.getElementById('s2_1_curr_pure').innerText]);
            sheet.addRow(['ì¦ê°', document.getElementById('s2_1_diff_total').innerText, '', document.getElementById('s2_1_diff_pure').innerText]);

            // Step 2-2 ë¸”ëŸ­ë³„ ë§¤ì¶œ (ë™ì  í…Œì´ë¸” ìˆœíšŒ)
            document.querySelectorAll('[id^="block_table_"]').forEach(div => {
                const blockName = div.querySelector('strong').innerText;
                const rows = div.querySelectorAll('tr');
                sheet.addRow([]);
                sheet.addRow([blockName]);
                sheet.addRow(['êµ¬ë¶„', 'ì „ì²´ë§¤ì¶œ', 'ë¸”ëŸ­ë§¤ì¶œ', 'êµ¬ì„±ë¹„']);
                const lastRow = rows[1].cells;
                sheet.addRow(['ì „ë…„', lastRow[1].querySelector('input').value, lastRow[2].querySelector('input').value, lastRow[3].innerText]);
                const currRow = rows[2].cells;
                sheet.addRow(['ê¸ˆë…„', currRow[1].querySelector('input').value, currRow[2].querySelector('input').value, currRow[3].innerText]);
            });

            // Step 3 ì†ìµ (ë™ì  í…Œì´ë¸” ìˆœíšŒ)
            sheet.addRow([]);
            const s3Header = sheet.addRow(['â–  Step 3. ì†ìµ ë¶„ì„ (ê³„ì •ê³¼ëª©ë³„)']);
            s3Header.getCell(1).style = headerStyle;
            document.querySelectorAll('#accountTableContainer > div').forEach(div => {
                const accName = div.querySelector('select').value;
                const last = div.querySelector('[id^="s3_last_"]').value;
                const curr = div.querySelector('[id^="s3_curr_"]').value;
                const growth = div.querySelector('[id^="s3_res_"]').innerText;
                const memo = div.querySelector('textarea').value;
                sheet.addRow([accName, 'ì „ë…„:'+last, 'ê¸ˆë…„:'+curr, 'ì¦ê°:'+growth]);
                sheet.addRow(['ë¶„ì„ë‚´ìš©', memo]);
            });

            // Step 4 ì¸ê±´ë¹„
            sheet.addRow([]);
            const s4Header = sheet.addRow(['â–  Step 4. ì¸ì‚¬ ì ê²€']);
            s4Header.getCell(1).style = headerStyle;
            sheet.addRow(['êµ¬ë¶„', 'ì¸ê±´ë¹„(ì²œì›)', 'ì‚¬ìš©ì‹œê°„', 'ì¦ê°ìœ¨']);
            sheet.addRow(['ì „ë…„', formData.get('s4_1_last_cost'), formData.get('s4_1_last_time'), '']);
            sheet.addRow(['ê¸ˆë…„', formData.get('s4_1_curr_cost'), formData.get('s4_1_curr_time'), document.getElementById('s4_1_res').innerText]);

            // Step 5 ìˆ˜ìœ¨
            sheet.addRow([]);
            const s5Header = sheet.addRow(['â–  Step 5. ìƒì‚° ì í¬ ìˆ˜ìœ¨']);
            s5Header.getCell(1).style = headerStyle;
            sheet.addRow(['ë¯¹ìŠ¤ ìˆ˜ìœ¨', formData.get('s5_yield_mix') + '%', 'ê°œë‹¹ ì¸ê±´ë¹„', formData.get('s5_labor_cost') + 'ì›']);
        }

        // ì „ì²´ í…Œë‘ë¦¬ ì ìš©
        sheet.eachRow(row => {
            row.eachCell(cell => {
                cell.border = { top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'} };
                if (typeof cell.value === 'number') cell.numFmt = '#,##0';
            });
        });

        const buffer = await workbook.xlsx.writeBuffer();
        saveAs(new Blob([buffer]), `${fileName}.xlsx`);
    }

    function openHistory() { alert("ê¸°ë¡ ì¡°íšŒ ê¸°ëŠ¥"); }
    function saveToDataCenter() { alert("DB ì €ì¥ ê¸°ëŠ¥"); }
    function sendEmail() { saveAsExcel(); }
</script>

</body>
</html>
